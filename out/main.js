// Copyright Charles Dueck 2020
import { Viewport, PanGesture, PinchZoomGesture } from "./viewport.js";
import { TouchDemux } from "./touch.js";
import { Gestures } from "./gesture.js";
import { sceneMethod, sceneRenderer } from "./scene.js";
const c = document.getElementById("canvas");
if (c === null) {
    throw new Error("No canvas element");
}
const ctx = c.getContext("2d");
if (ctx === null) {
    throw new Error("No 2d context");
}
/*
//     0 - 1 - 2
//   / | \ | / | \
// 6 - 3 - 4 - 5 - 7

const scene: Scene = {
    truss: {
        pins: [
            [35.0, 35.0],
            [40.0, 35.0],
            [45.0, 35.0],
            [35.0, 30.0],
            [40.0, 30.0],
            [45.0, 30.0],
            [30.0, 30.0],
            [50.0, 30.0],
        ],
        mobilePins: 8,
        beams: [
            { p1: 0, p2: 1, m: 0, w: 0.1 },
            { p1: 1, p2: 2, m: 0, w: 0.1 },
            { p1: 6, p2: 0, m: 0, w: 0.1 },
            { p1: 3, p2: 0, m: 0, w: 0.1 },
            { p1: 4, p2: 0, m: 0, w: 0.1 },
            { p1: 4, p2: 1, m: 0, w: 0.1 },
            { p1: 4, p2: 2, m: 0, w: 0.1 },
            { p1: 5, p2: 2, m: 0, w: 0.1 },
            { p1: 7, p2: 2, m: 0, w: 0.1 },
            { p1: 6, p2: 3, m: 0, w: 0.1, deck: true },
            { p1: 3, p2: 4, m: 0, w: 0.1, deck: true },
            { p1: 4, p2: 5, m: 0, w: 0.1, deck: true },
            { p1: 5, p2: 7, m: 0, w: 0.1, deck: true },
        ],
        discs: [
        ],
        materials: [
            {   // Rubber.
                E: 20000000.0,
                style: "black",
                density: 1200.0,
            },
        ],
    },
    terrain: {
        hmap: [
            40.0,
            16.0,
            14.0,
            12.0,
            10.0,
            8.0,
            6.0,
            5.0,
            4.0,
            4.0,
            40.0,
        ],
        style: "darkgrey",
        pitch: 10.0,
        friction: 0.5,
    },
    height: 100.0,
    g: [0.0, -9.8],
};
*/
//             0
//
// 6 - 1 - 2 - 3 - 4 - 5 - 7
const scene = {
    truss: {
        pins: [
            [40.0, 40.0],
            [25.0, 27.5],
            [30.0, 25.0],
            [35.0, 22.5],
            [40.0, 20.0],
            [45.0, 22.5],
            [50.0, 25.0],
            [55.0, 27.5],
            [20.0, 30.0],
            [60.0, 30.0],
        ],
        mobilePins: 8,
        beams: [
            { p1: 8, p2: 1, m: 0, w: 1.0, deck: true },
            { p1: 1, p2: 2, m: 0, w: 1.0, deck: true },
            { p1: 2, p2: 3, m: 0, w: 1.0, deck: true },
            { p1: 3, p2: 4, m: 0, w: 1.0, deck: true },
            { p1: 4, p2: 5, m: 0, w: 1.0, deck: true },
            { p1: 5, p2: 6, m: 0, w: 1.0, deck: true },
            { p1: 6, p2: 7, m: 0, w: 1.0, deck: true },
            { p1: 7, p2: 9, m: 0, w: 1.0, deck: true },
        ],
        discs: [
            { p: 0, r: 2.5, m: 0 },
        ],
        materials: [
            {
                E: 20000000.0,
                style: "black",
                density: 1200.0,
            },
        ],
    },
    terrain: {
        hmap: [
            40.0,
            16.0,
            14.0,
            12.0,
            10.0,
            8.0,
            6.0,
            5.0,
            4.0,
            4.0,
            40.0,
        ],
        style: "darkgrey",
        pitch: 10.0,
        friction: 0.5,
    },
    height: 100.0,
    g: [0.0, -9.8],
};
const ode = sceneMethod(scene);
const render = sceneRenderer(scene);
const vp = new Viewport(ctx, (_b, _s, ctx) => {
    render(ctx, ode);
});
function clip(v, min, max) {
    return Math.min(max, Math.max(min, v));
}
vp.setClipPosition((p) => {
    p.scale = clip(p.scale, 10.0, 1000.0);
    p.pos[0] = clip(p.pos[0], 0, scene.terrain.pitch * (scene.terrain.hmap.length - 1));
    p.pos[1] = clip(p.pos[1], 0, scene.height);
    p.rotate = 0.0;
    return p;
});
vp.setPosition({ pos: [50, 50] });
const h = 0.001;
requestAnimationFrame((t0) => {
    function mainLoop(t) {
        // Compute up to 250ms worth of frames at a time.
        const dt = Math.min(t - t0, 250.0);
        const frames = Math.floor(dt / (1000.0 * h));
        for (let i = 0; i < frames; i++) {
            ode.next(h);
        }
        vp.requestRedraw();
        // Only let the physics backlog get to 250ms.
        t0 = Math.max(t0 + frames * h * 1000.0, t - 250.0);
        requestAnimationFrame(mainLoop);
    }
    requestAnimationFrame(mainLoop);
});
window.addEventListener("resize", vp.resize);
const touch = new TouchDemux(c);
const gesture = new Gestures();
touch.addTouchHandler(gesture);
gesture.addGestureHandler(new PanGesture(vp));
gesture.addGestureHandler(new PinchZoomGesture(vp));
// TODO: mouse and trackpad input
// scroll
// scroll wheel zoom in and out
// what to rotate? right click drag, rotate around center of vp? Maybe don't care, since bridge wont use rotate
// TODO: https://developer.mozilla.org/en-US/docs/Web/API/Element/requestFullscreen
// https://developer.mozilla.org/en-US/docs/Web/API/Fullscreen_API/Guide
// Look into this
// TODO: discs. Attached to pins, repel terrain at a distance (with friction)
// TODO: discs can rotate at a fixed rate. Rotation only applies to friction force calculation.
// TODO: deck beams. Like regular beams, but repel discs
// TODO: rewrite viewport etc. to not take callbacks, just call into it to explcitly set up canvas, etc.
// TODO: Physics calculation in a web-worker.
// TODO: Air resistance, or at least damping of pin movement, not just beam spring forces. Keep beam damping, this should be independent.
// TODO: Beam buckling.
console.log("stuff loaded");
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLCtCQUErQjtBQUUvQixPQUFPLEVBQUUsUUFBUSxFQUFvQixVQUFVLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDeEYsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFlBQVksQ0FBQTtBQUN2QyxPQUFPLEVBQUUsUUFBUSxFQUFDLE1BQU0sY0FBYyxDQUFBO0FBQ3RDLE9BQU8sRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFTLE1BQU0sWUFBWSxDQUFDO0FBRS9ELE1BQU0sQ0FBQyxHQUFJLFFBQVEsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUF1QixDQUFDO0FBQ25FLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtJQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQztDQUN4QztBQUNELE1BQU0sR0FBRyxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDL0IsSUFBSSxHQUFHLEtBQUssSUFBSSxFQUFFO0lBQ2QsTUFBTSxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztDQUNwQztBQUNEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0VBZ0VFO0FBRUYsZ0JBQWdCO0FBQ2hCLEVBQUU7QUFDRiw0QkFBNEI7QUFDNUIsTUFBTSxLQUFLLEdBQVU7SUFDakIsS0FBSyxFQUFFO1FBQ0gsSUFBSSxFQUFFO1lBQ0YsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ1osQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ1osQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ1osQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ1osQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ1osQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ1osQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ1osQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ1osQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1lBQ1osQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDO1NBQ2Y7UUFDRCxVQUFVLEVBQUUsQ0FBQztRQUNiLEtBQUssRUFBRTtZQUNILEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQzFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQzFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQzFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQzFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQzFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFO1lBQzFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFB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L0Ysd0RBQXdEO0FBRXhELHdHQUF3RztBQUV4Ryw2Q0FBNkM7QUFFN0MseUlBQXlJO0FBRXpJLHVCQUF1QjtBQUV2QixPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IENoYXJsZXMgRHVlY2sgMjAyMFxuXG5pbXBvcnQgeyBWaWV3cG9ydCwgVmlld3BvcnRQb3NpdGlvbiwgUGFuR2VzdHVyZSwgUGluY2hab29tR2VzdHVyZSB9IGZyb20gXCIuL3ZpZXdwb3J0LmpzXCJcbmltcG9ydCB7IFRvdWNoRGVtdXggfSBmcm9tIFwiLi90b3VjaC5qc1wiXG5pbXBvcnQgeyBHZXN0dXJlc30gZnJvbSBcIi4vZ2VzdHVyZS5qc1wiXG5pbXBvcnQgeyBzY2VuZU1ldGhvZCwgc2NlbmVSZW5kZXJlciwgU2NlbmUgfSBmcm9tIFwiLi9zY2VuZS5qc1wiO1xuXG5jb25zdCBjID0gKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiY2FudmFzXCIpIGFzIEhUTUxDYW52YXNFbGVtZW50KTtcbmlmIChjID09PSBudWxsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTm8gY2FudmFzIGVsZW1lbnRcIik7XG59XG5jb25zdCBjdHggPSBjLmdldENvbnRleHQoXCIyZFwiKTtcbmlmIChjdHggPT09IG51bGwpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJObyAyZCBjb250ZXh0XCIpO1xufVxuLypcbi8vICAgICAwIC0gMSAtIDJcbi8vICAgLyB8IFxcIHwgLyB8IFxcXG4vLyA2IC0gMyAtIDQgLSA1IC0gN1xuXG5jb25zdCBzY2VuZTogU2NlbmUgPSB7XG4gICAgdHJ1c3M6IHtcbiAgICAgICAgcGluczogW1xuICAgICAgICAgICAgWzM1LjAsIDM1LjBdLFxuICAgICAgICAgICAgWzQwLjAsIDM1LjBdLFxuICAgICAgICAgICAgWzQ1LjAsIDM1LjBdLFxuICAgICAgICAgICAgWzM1LjAsIDMwLjBdLFxuICAgICAgICAgICAgWzQwLjAsIDMwLjBdLFxuICAgICAgICAgICAgWzQ1LjAsIDMwLjBdLFxuICAgICAgICAgICAgWzMwLjAsIDMwLjBdLFxuICAgICAgICAgICAgWzUwLjAsIDMwLjBdLFxuICAgICAgICBdLFxuICAgICAgICBtb2JpbGVQaW5zOiA4LFxuICAgICAgICBiZWFtczogW1xuICAgICAgICAgICAgeyBwMTogMCwgcDI6IDEsIG06IDAsIHc6IDAuMSB9LFxuICAgICAgICAgICAgeyBwMTogMSwgcDI6IDIsIG06IDAsIHc6IDAuMSB9LFxuICAgICAgICAgICAgeyBwMTogNiwgcDI6IDAsIG06IDAsIHc6IDAuMSB9LFxuICAgICAgICAgICAgeyBwMTogMywgcDI6IDAsIG06IDAsIHc6IDAuMSB9LFxuICAgICAgICAgICAgeyBwMTogNCwgcDI6IDAsIG06IDAsIHc6IDAuMSB9LFxuICAgICAgICAgICAgeyBwMTogNCwgcDI6IDEsIG06IDAsIHc6IDAuMSB9LFxuICAgICAgICAgICAgeyBwMTogNCwgcDI6IDIsIG06IDAsIHc6IDAuMSB9LFxuICAgICAgICAgICAgeyBwMTogNSwgcDI6IDIsIG06IDAsIHc6IDAuMSB9LFxuICAgICAgICAgICAgeyBwMTogNywgcDI6IDIsIG06IDAsIHc6IDAuMSB9LFxuICAgICAgICAgICAgeyBwMTogNiwgcDI6IDMsIG06IDAsIHc6IDAuMSwgZGVjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBwMTogMywgcDI6IDQsIG06IDAsIHc6IDAuMSwgZGVjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBwMTogNCwgcDI6IDUsIG06IDAsIHc6IDAuMSwgZGVjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBwMTogNSwgcDI6IDcsIG06IDAsIHc6IDAuMSwgZGVjazogdHJ1ZSB9LFxuICAgICAgICBdLFxuICAgICAgICBkaXNjczogW1xuICAgICAgICBdLFxuICAgICAgICBtYXRlcmlhbHM6IFtcbiAgICAgICAgICAgIHsgICAvLyBSdWJiZXIuXG4gICAgICAgICAgICAgICAgRTogMjAwMDAwMDAuMCxcbiAgICAgICAgICAgICAgICBzdHlsZTogXCJibGFja1wiLFxuICAgICAgICAgICAgICAgIGRlbnNpdHk6IDEyMDAuMCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgIF0sXG4gICAgfSxcbiAgICB0ZXJyYWluOiB7XG4gICAgICAgIGhtYXA6IFtcbiAgICAgICAgICAgIDQwLjAsXG4gICAgICAgICAgICAxNi4wLFxuICAgICAgICAgICAgMTQuMCxcbiAgICAgICAgICAgIDEyLjAsXG4gICAgICAgICAgICAxMC4wLFxuICAgICAgICAgICAgOC4wLFxuICAgICAgICAgICAgNi4wLFxuICAgICAgICAgICAgNS4wLFxuICAgICAgICAgICAgNC4wLFxuICAgICAgICAgICAgNC4wLFxuICAgICAgICAgICAgNDAuMCxcbiAgICAgICAgXSxcbiAgICAgICAgc3R5bGU6IFwiZGFya2dyZXlcIixcbiAgICAgICAgcGl0Y2g6IDEwLjAsXG4gICAgICAgIGZyaWN0aW9uOiAwLjUsXG4gICAgfSxcbiAgICBoZWlnaHQ6IDEwMC4wLFxuICAgIGc6IFswLjAsIC05LjhdLFxufTtcbiovXG5cbi8vICAgICAgICAgICAgIDBcbi8vXG4vLyA2IC0gMSAtIDIgLSAzIC0gNCAtIDUgLSA3XG5jb25zdCBzY2VuZTogU2NlbmUgPSB7XG4gICAgdHJ1c3M6IHtcbiAgICAgICAgcGluczogW1xuICAgICAgICAgICAgWzQwLjAsIDQwLjBdLFxuICAgICAgICAgICAgWzI1LjAsIDI3LjVdLFxuICAgICAgICAgICAgWzMwLjAsIDI1LjBdLFxuICAgICAgICAgICAgWzM1LjAsIDIyLjVdLFxuICAgICAgICAgICAgWzQwLjAsIDIwLjBdLFxuICAgICAgICAgICAgWzQ1LjAsIDIyLjVdLFxuICAgICAgICAgICAgWzUwLjAsIDI1LjBdLFxuICAgICAgICAgICAgWzU1LjAsIDI3LjVdLFxuICAgICAgICAgICAgWzIwLjAsIDMwLjBdLFxuICAgICAgICAgICAgWzYwLjAsIDMwLjBdLFxuICAgICAgICBdLFxuICAgICAgICBtb2JpbGVQaW5zOiA4LFxuICAgICAgICBiZWFtczogW1xuICAgICAgICAgICAgeyBwMTogOCwgcDI6IDEsIG06IDAsIHc6IDEuMCwgZGVjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBwMTogMSwgcDI6IDIsIG06IDAsIHc6IDEuMCwgZGVjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBwMTogMiwgcDI6IDMsIG06IDAsIHc6IDEuMCwgZGVjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBwMTogMywgcDI6IDQsIG06IDAsIHc6IDEuMCwgZGVjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBwMTogNCwgcDI6IDUsIG06IDAsIHc6IDEuMCwgZGVjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBwMTogNSwgcDI6IDYsIG06IDAsIHc6IDEuMCwgZGVjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBwMTogNiwgcDI6IDcsIG06IDAsIHc6IDEuMCwgZGVjazogdHJ1ZSB9LFxuICAgICAgICAgICAgeyBwMTogNywgcDI6IDksIG06IDAsIHc6IDEuMCwgZGVjazogdHJ1ZSB9LFxuICAgICAgICBdLFxuICAgICAgICBkaXNjczogW1xuICAgICAgICAgICAgeyBwOiAwLCByOiAyLjUsIG06IDAgfSxcbiAgICAgICAgXSxcbiAgICAgICAgbWF0ZXJpYWxzOiBbXG4gICAgICAgICAgICB7ICAgLy8gUnViYmVyLlxuICAgICAgICAgICAgICAgIEU6IDIwMDAwMDAwLjAsXG4gICAgICAgICAgICAgICAgc3R5bGU6IFwiYmxhY2tcIixcbiAgICAgICAgICAgICAgICBkZW5zaXR5OiAxMjAwLjAsXG4gICAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgIH0sXG4gICAgdGVycmFpbjoge1xuICAgICAgICBobWFwOiBbXG4gICAgICAgICAgICA0MC4wLFxuICAgICAgICAgICAgMTYuMCxcbiAgICAgICAgICAgIDE0LjAsXG4gICAgICAgICAgICAxMi4wLFxuICAgICAgICAgICAgMTAuMCxcbiAgICAgICAgICAgIDguMCxcbiAgICAgICAgICAgIDYuMCxcbiAgICAgICAgICAgIDUuMCxcbiAgICAgICAgICAgIDQuMCxcbiAgICAgICAgICAgIDQuMCxcbiAgICAgICAgICAgIDQwLjAsXG4gICAgICAgIF0sXG4gICAgICAgIHN0eWxlOiBcImRhcmtncmV5XCIsXG4gICAgICAgIHBpdGNoOiAxMC4wLFxuICAgICAgICBmcmljdGlvbjogMC41LFxuICAgIH0sXG4gICAgaGVpZ2h0OiAxMDAuMCxcbiAgICBnOiBbMC4wLCAtOS44XSxcbn07XG5cbmNvbnN0IG9kZSA9IHNjZW5lTWV0aG9kKHNjZW5lKTtcbmNvbnN0IHJlbmRlciA9IHNjZW5lUmVuZGVyZXIoc2NlbmUpO1xuXG5jb25zdCB2cCA9IG5ldyBWaWV3cG9ydChjdHgsIChfYiwgX3MsIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEKSA9PiB7XG4gICAgcmVuZGVyKGN0eCwgb2RlKTtcbn0pO1xuXG5mdW5jdGlvbiBjbGlwKHY6IG51bWJlciwgbWluOiBudW1iZXIsIG1heDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gTWF0aC5taW4obWF4LCBNYXRoLm1heChtaW4sIHYpKTtcbn1cblxudnAuc2V0Q2xpcFBvc2l0aW9uKChwOiBWaWV3cG9ydFBvc2l0aW9uKTogVmlld3BvcnRQb3NpdGlvbiA9PiB7XG4gICAgcC5zY2FsZSA9IGNsaXAocC5zY2FsZSwgMTAuMCwgMTAwMC4wKTtcbiAgICBwLnBvc1swXSA9IGNsaXAocC5wb3NbMF0sIDAsIHNjZW5lLnRlcnJhaW4ucGl0Y2ggKiAoc2NlbmUudGVycmFpbi5obWFwLmxlbmd0aCAtIDEpKTtcbiAgICBwLnBvc1sxXSA9IGNsaXAocC5wb3NbMV0sIDAsIHNjZW5lLmhlaWdodCk7XG4gICAgcC5yb3RhdGUgPSAwLjA7XG4gICAgcmV0dXJuIHA7XG59KTtcblxudnAuc2V0UG9zaXRpb24oeyBwb3M6IFs1MCwgNTBdfSk7XG5cbmNvbnN0IGggPSAwLjAwMTtcbnJlcXVlc3RBbmltYXRpb25GcmFtZSgodDA6IERPTUhpZ2hSZXNUaW1lU3RhbXApID0+IHtcbiAgICBmdW5jdGlvbiBtYWluTG9vcCh0OiBET01IaWdoUmVzVGltZVN0YW1wKSB7XG4gICAgICAgIC8vIENvbXB1dGUgdXAgdG8gMjUwbXMgd29ydGggb2YgZnJhbWVzIGF0IGEgdGltZS5cbiAgICAgICAgY29uc3QgZHQgPSBNYXRoLm1pbih0IC0gdDAsIDI1MC4wKTtcbiAgICAgICAgY29uc3QgZnJhbWVzID0gTWF0aC5mbG9vcihkdCAvICgxMDAwLjAgKiBoKSk7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZnJhbWVzOyBpKyspIHtcbiAgICAgICAgICAgIG9kZS5uZXh0KGgpO1xuICAgICAgICB9XG4gICAgICAgIHZwLnJlcXVlc3RSZWRyYXcoKTtcbiAgICAgICAgLy8gT25seSBsZXQgdGhlIHBoeXNpY3MgYmFja2xvZyBnZXQgdG8gMjUwbXMuXG4gICAgICAgIHQwID0gTWF0aC5tYXgodDAgKyBmcmFtZXMgKiBoICogMTAwMC4wLCB0IC0gMjUwLjApO1xuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUobWFpbkxvb3ApO1xuICAgIH1cbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUobWFpbkxvb3ApO1xufSk7XG5cbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwicmVzaXplXCIsIHZwLnJlc2l6ZSk7XG5cbmNvbnN0IHRvdWNoID0gbmV3IFRvdWNoRGVtdXgoYyk7XG5jb25zdCBnZXN0dXJlID0gbmV3IEdlc3R1cmVzKCk7XG50b3VjaC5hZGRUb3VjaEhhbmRsZXIoZ2VzdHVyZSk7XG5nZXN0dXJlLmFkZEdlc3R1cmVIYW5kbGVyKG5ldyBQYW5HZXN0dXJlKHZwKSk7XG5nZXN0dXJlLmFkZEdlc3R1cmVIYW5kbGVyKG5ldyBQaW5jaFpvb21HZXN0dXJlKHZwKSk7XG5cbi8vIFRPRE86IG1vdXNlIGFuZCB0cmFja3BhZCBpbnB1dFxuLy8gc2Nyb2xsXG4vLyBzY3JvbGwgd2hlZWwgem9vbSBpbiBhbmQgb3V0XG4vLyB3aGF0IHRvIHJvdGF0ZT8gcmlnaHQgY2xpY2sgZHJhZywgcm90YXRlIGFyb3VuZCBjZW50ZXIgb2YgdnA/IE1heWJlIGRvbid0IGNhcmUsIHNpbmNlIGJyaWRnZSB3b250IHVzZSByb3RhdGVcblxuLy8gVE9ETzogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL0VsZW1lbnQvcmVxdWVzdEZ1bGxzY3JlZW5cbi8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9GdWxsc2NyZWVuX0FQSS9HdWlkZVxuLy8gTG9vayBpbnRvIHRoaXNcblxuLy8gVE9ETzogZGlzY3MuIEF0dGFjaGVkIHRvIHBpbnMsIHJlcGVsIHRlcnJhaW4gYXQgYSBkaXN0YW5jZSAod2l0aCBmcmljdGlvbilcbi8vIFRPRE86IGRpc2NzIGNhbiByb3RhdGUgYXQgYSBmaXhlZCByYXRlLiBSb3RhdGlvbiBvbmx5IGFwcGxpZXMgdG8gZnJpY3Rpb24gZm9yY2UgY2FsY3VsYXRpb24uXG5cbi8vIFRPRE86IGRlY2sgYmVhbXMuIExpa2UgcmVndWxhciBiZWFtcywgYnV0IHJlcGVsIGRpc2NzXG5cbi8vIFRPRE86IHJld3JpdGUgdmlld3BvcnQgZXRjLiB0byBub3QgdGFrZSBjYWxsYmFja3MsIGp1c3QgY2FsbCBpbnRvIGl0IHRvIGV4cGxjaXRseSBzZXQgdXAgY2FudmFzLCBldGMuXG5cbi8vIFRPRE86IFBoeXNpY3MgY2FsY3VsYXRpb24gaW4gYSB3ZWItd29ya2VyLlxuXG4vLyBUT0RPOiBBaXIgcmVzaXN0YW5jZSwgb3IgYXQgbGVhc3QgZGFtcGluZyBvZiBwaW4gbW92ZW1lbnQsIG5vdCBqdXN0IGJlYW0gc3ByaW5nIGZvcmNlcy4gS2VlcCBiZWFtIGRhbXBpbmcsIHRoaXMgc2hvdWxkIGJlIGluZGVwZW5kZW50LlxuXG4vLyBUT0RPOiBCZWFtIGJ1Y2tsaW5nLlxuXG5jb25zb2xlLmxvZyhcInN0dWZmIGxvYWRlZFwiKTtcbiJdfQ==