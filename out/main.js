import { Viewport } from "./viewport.js";
import { pointDistance, pointEquals } from "./point.js";
const c = document.getElementById("canvas");
if (c === null) {
    throw new Error("No canvas element");
}
const ctx = c.getContext("2d");
if (ctx === null) {
    throw new Error("No 2d context");
}
const vp = new Viewport(ctx, () => {
    ctx.fillStyle = "black";
    ctx.fillRect(-16, -16, 32, 32);
});
window.addEventListener("resize", vp.resize);
export class TouchDemux {
    constructor(e, h) {
        this.active = new Map();
        const start = (evt) => {
            evt.preventDefault();
            for (const t of evt.touches) {
                if (!this.active.has(t.identifier)) {
                    this.active.set(t.identifier, [t.clientX, t.clientY]);
                    h.start(t);
                }
            }
        };
        const move = (evt) => {
            evt.preventDefault();
            let moved = false;
            for (const t of evt.touches) {
                const a = this.active.get(t.identifier);
                if (a === undefined) {
                    throw new Error("Touch moved without being started");
                }
                if (a[0] != t.clientX || a[1] != t.clientY) {
                    moved = true;
                }
            }
            if (moved) {
                h.move(evt.touches);
            }
        };
        const end = (evt) => {
            evt.preventDefault();
            const removed = new Set(this.active.keys());
            for (const t of evt.touches) {
                removed.delete(t.identifier);
            }
            for (const id of removed) {
                this.active.delete(id);
                h.end(id);
            }
        };
        e.addEventListener("touchstart", start, false);
        e.addEventListener("touchmove", move, false);
        e.addEventListener("touchend", end, false);
        e.addEventListener("touchcancel", end, false);
    }
}
;
;
export class Gestures {
    constructor(h) {
        this.h = h;
        this.addTap = null;
        this.taps = new Map();
        this.pan = new Map();
    }
    endTap(tap, id) {
        this.taps.delete(id);
        tap.active.delete(id);
        tap.positions.delete(id);
        if (this.addTap === tap) {
            this.addTap = null;
        }
        if (tap.active.size === 0) {
            const positions = [];
            for (const p of tap.positions.values()) {
                positions.push(p.start);
            }
            this.h.tap(positions);
        }
    }
    start(t) {
        if (this.taps.has(t.identifier)) {
            throw new Error("Touch start on already tracked tap");
        }
        if (this.addTap === null) {
            // If no taps are active, set up a tap to add a touch to.
            this.addTap = {
                active: new Set(),
                positions: new Map(),
            };
        }
        this.addTap.active.add(t.identifier);
        const pos = [t.clientX, t.clientY];
        this.addTap.positions.set(t.identifier, {
            curr: pos,
            start: pos,
        });
        this.taps.set(t.identifier, this.addTap);
    }
    move(ts) {
        let panMoved = false;
        for (const t of ts) {
            const tap = this.taps.get(t.identifier);
            if (tap !== undefined) {
                const pos = tap.positions.get(t.identifier);
                if (pos === undefined) {
                    throw new Error("Touch in taps, but not positions");
                }
                pos.curr = [t.clientX, t.clientY];
                if (16 <= pointDistance(pos.curr, pos.start)) {
                    // Tap has moved enough to be a pan instead.
                    this.endTap(tap, t.identifier);
                    this.pan.set(t.identifier, {
                        curr: pos.curr,
                        prev: pos.start,
                        start: pos.start,
                    });
                    panMoved = true;
                }
            }
            else {
                const pos = this.pan.get(t.identifier);
                if (pos === undefined) {
                    throw new Error("Touch not in taps or pans");
                }
                pos.prev = pos.curr;
                pos.curr = [t.clientX, t.clientY];
                if (!pointEquals(pos.prev, pos.curr)) {
                    panMoved = true;
                }
            }
        }
        if (panMoved) {
            const positions = [];
            for (const p of this.pan.values()) {
                positions.push(p);
            }
            this.h.pan(positions);
        }
    }
    end(id) {
        const tap = this.taps.get(id);
        if (tap !== undefined) {
            this.endTap(tap, id);
        }
        else if (!this.pan.delete(id)) {
            throw new Error("Touch end that was not a tap or a pan");
        }
    }
}
;
new TouchDemux(c, new Gestures({
    tap: (t) => {
        console.log("tap: ", t);
    },
    pan: (p) => {
        console.log("pan: ", p);
    },
}));
console.log("stuff loaded");
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQW9CLE1BQU0sZUFBZSxDQUFBO0FBQzFELE9BQU8sRUFBVyxhQUFhLEVBQUUsV0FBVyxFQUFFLE1BQU0sWUFBWSxDQUFBO0FBRWhFLE1BQU0sQ0FBQyxHQUFJLFFBQVEsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUF1QixDQUFDO0FBQ25FLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRTtJQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsbUJBQW1CLENBQUMsQ0FBQztDQUN4QztBQUNELE1BQU0sR0FBRyxHQUFHLENBQUMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDL0IsSUFBSSxHQUFHLEtBQUssSUFBSSxFQUFFO0lBQ2QsTUFBTSxJQUFJLEtBQUssQ0FBQyxlQUFlLENBQUMsQ0FBQztDQUNwQztBQUNELE1BQU0sRUFBRSxHQUFHLElBQUksUUFBUSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUU7SUFDOUIsR0FBRyxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUM7SUFDeEIsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDbkMsQ0FBQyxDQUFDLENBQUM7QUFFSCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQVE3QyxNQUFNLE9BQU8sVUFBVTtJQUluQixZQUFZLENBQWMsRUFBRSxDQUFlO1FBQ3ZDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxHQUFHLEVBQW1CLENBQUM7UUFFekMsTUFBTSxLQUFLLEdBQUcsQ0FBQyxHQUFlLEVBQUUsRUFBRTtZQUM5QixHQUFHLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDckIsS0FBSyxNQUFNLENBQUMs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LElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFO1lBQzdCLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLENBQUMsQ0FBQztTQUM1RDtJQUNMLENBQUM7Q0FDSjtBQUFBLENBQUM7QUFNRixJQUFJLFVBQVUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxRQUFRLENBQUM7SUFDM0IsR0FBRyxFQUFFLENBQUMsQ0FBTSxFQUFFLEVBQUU7UUFDWixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBQ0QsR0FBRyxFQUFFLENBQUMsQ0FBTSxFQUFFLEVBQUU7UUFDWixPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztJQUM1QixDQUFDO0NBQ0osQ0FBQyxDQUFDLENBQUM7QUFFSixPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmlld3BvcnQsIFZpZXdwb3J0UG9zaXRpb24gfSBmcm9tIFwiLi92aWV3cG9ydC5qc1wiXG5pbXBvcnQgeyBQb2ludDJELCBwb2ludERpc3RhbmNlLCBwb2ludEVxdWFscyB9IGZyb20gXCIuL3BvaW50LmpzXCJcblxuY29uc3QgYyA9IChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImNhbnZhc1wiKSBhcyBIVE1MQ2FudmFzRWxlbWVudCk7XG5pZiAoYyA9PT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIk5vIGNhbnZhcyBlbGVtZW50XCIpO1xufVxuY29uc3QgY3R4ID0gYy5nZXRDb250ZXh0KFwiMmRcIik7XG5pZiAoY3R4ID09PSBudWxsKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTm8gMmQgY29udGV4dFwiKTtcbn1cbmNvbnN0IHZwID0gbmV3IFZpZXdwb3J0KGN0eCwgKCkgPT4ge1xuICAgIGN0eC5maWxsU3R5bGUgPSBcImJsYWNrXCI7XG4gICAgY3R4LmZpbGxSZWN0KC0xNiwgLTE2LCAzMiwgMzIpO1xufSk7XG5cbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwicmVzaXplXCIsIHZwLnJlc2l6ZSk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG91Y2hIYW5kbGVyIHtcbiAgICBzdGFydDogKHQ6IFRvdWNoKSA9PiB2b2lkO1xuICAgIG1vdmU6ICh0czogVG91Y2hMaXN0KSA9PiB2b2lkO1xuICAgIGVuZDogKGlkOiBudW1iZXIpID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBjbGFzcyBUb3VjaERlbXV4IHtcbiAgICAvLyBNYXAgb2YgYWN0aXZlIHRvdWNoIElEcyB0byB0aGVpciBjb29yZGluYXRlc1xuICAgIHByaXZhdGUgYWN0aXZlOiBNYXA8bnVtYmVyLCBQb2ludDJEPjtcblxuICAgIGNvbnN0cnVjdG9yKGU6IEhUTUxFbGVtZW50LCBoOiBUb3VjaEhhbmRsZXIpIHtcbiAgICAgICAgdGhpcy5hY3RpdmUgPSBuZXcgTWFwPG51bWJlciwgUG9pbnQyRD4oKTtcblxuICAgICAgICBjb25zdCBzdGFydCA9IChldnQ6IFRvdWNoRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgZm9yIChjb25zdCB0IG9mIGV2dC50b3VjaGVzKSB7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmFjdGl2ZS5oYXModC5pZGVudGlmaWVyKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZS5zZXQodC5pZGVudGlmaWVyLCBbdC5jbGllbnRYLCB0LmNsaWVudFldKTtcbiAgICAgICAgICAgICAgICAgICAgaC5zdGFydCh0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07IFxuICAgICAgICBjb25zdCBtb3ZlID0gKGV2dDogVG91Y2hFdmVudCkgPT4ge1xuICAgICAgICAgICAgZXZ0LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBsZXQgbW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiBldnQudG91Y2hlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGEgPSB0aGlzLmFjdGl2ZS5nZXQodC5pZGVudGlmaWVyKTtcbiAgICAgICAgICAgICAgICBpZiAoYSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRvdWNoIG1vdmVkIHdpdGhvdXQgYmVpbmcgc3RhcnRlZFwiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGFbMF0gIT0gdC5jbGllbnRYIHx8IGFbMV0gIT0gdC5jbGllbnRZKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobW92ZWQpIHtcbiAgICAgICAgICAgICAgICBoLm1vdmUoZXZ0LnRvdWNoZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBlbmQgPSAoZXZ0OiBUb3VjaEV2ZW50KSA9PiB7XG4gICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICBcbiAgICAgICAgICAgIGNvbnN0IHJlbW92ZWQgPSBuZXcgU2V0PG51bWJlcj4odGhpcy5hY3RpdmUua2V5cygpKTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiBldnQudG91Y2hlcykge1xuICAgICAgICAgICAgICAgIHJlbW92ZWQuZGVsZXRlKHQuaWRlbnRpZmllcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGlkIG9mIHJlbW92ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZS5kZWxldGUoaWQpO1xuICAgICAgICAgICAgICAgIGguZW5kKGlkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgZS5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hzdGFydFwiLCBzdGFydCwgZmFsc2UpO1xuICAgICAgICBlLmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaG1vdmVcIiwgbW92ZSwgZmFsc2UpO1xuICAgICAgICBlLmFkZEV2ZW50TGlzdGVuZXIoXCJ0b3VjaGVuZFwiLCBlbmQsIGZhbHNlKTtcbiAgICAgICAgZS5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hjYW5jZWxcIiwgZW5kLCBmYWxzZSk7XG4gICAgfVxufTtcblxuZXhwb3J0IHR5cGUgVGFwID0gQXJyYXk8UG9pbnQyRD47XG5cbmV4cG9ydCB0eXBlIFBhbiA9IEFycmF5PHtcbiAgICBzdGFydDogUG9pbnQyRDtcbiAgICBwcmV2OiBQb2ludDJEO1xuICAgIGN1cnI6IFBvaW50MkQ7XG59PjtcblxuZXhwb3J0IGludGVyZmFjZSBHZXN0dXJlSGFuZGxlciB7XG4gICAgdGFwOiAodDogVGFwKSA9PiB2b2lkO1xuICAgIHBhbjogKHA6IFBhbikgPT4gdm9pZDtcbn07XG5cbi8vIFRvdWNoIGhhbmRsaW5nXG4vLyAqIGRldGVjdCBpZiBhIHRvdWNoIGlzIGEgdGFwIG9yIGEgcGFuXG4vLyAgICogdGFwcyBkb24ndCBtb3ZlIG1vcmUgdGhhbiAxNiBwaXhlbHNcbi8vICAgKiBtYXliZTogdGFwcyBhcmUgZmFzdGVyIHRoYW4geDAwbXMsIFRPRE86IGluc3RydW1lbnQgYW5kIGZpbmQgb3V0IHdoYXQgZmVlbHMgT0tcbi8vICogcHJvY2VzcyB0YXBzXG4vLyAgICogZmlyc3QgdG91Y2ggc3RhcnRzIGFjdGl2ZSB0YXBcbi8vICAgKiBhbGwgc3Vic2VxdWVudCB0b3VjaGVzIGFkZGVkIHRvIHRhcFxuLy8gICAqIHRhcCBhY3RpdmUgdW50aWwgZmlyc3QgdG91Y2ggZW5kXG4vLyAgICogdGFwIGZpcmVzIHdoZW4gb24gbGFzdCB0b3VjaCBlbmQgKG9yIHRvdWNoIGNvbnZlcnRlZCB0byBwYW4pLCB1bmxlc3Mgbm8gdGFwcyByZW1haW4gKGFsbCBjb252ZXJ0ZWQgdG8gcGFuKVxuLy8gICAqIG5ldyBhY3RpdmUgdGFwIGNhbiBzdGFydCB3aGlsZSBvbGQgb25lIGlzIHJ1bm5pbmcgYnV0IG5vbG9uZ2VyIGFjdGl2ZVxuLy8gKiBhbGwgcGFucyBnZXQgcHV0IGludG8gYSBzaW5nbGUgcGFuIHRyYWNrZXJcblxudHlwZSBBY3RpdmVUYXAgPSB7XG4gICAgYWN0aXZlOiBTZXQ8bnVtYmVyPjtcbiAgICBwb3NpdGlvbnM6IE1hcDxudW1iZXIsIHtcbiAgICAgICAgY3VycjogUG9pbnQyRCxcbiAgICAgICAgc3RhcnQ6IFBvaW50MkQsXG4gICAgfT47XG59O1xuXG50eXBlIEFjdGl2ZVBhbiA9IE1hcDxudW1iZXIsIHtcbiAgICBjdXJyOiBQb2ludDJELFxuICAgIHByZXY6IFBvaW50MkQsXG4gICAgc3RhcnQ6IFBvaW50MkQsXG59PjtcblxuZXhwb3J0IGNsYXNzIEdlc3R1cmVzIGltcGxlbWVudHMgVG91Y2hIYW5kbGVyIHtcbiAgICBwcml2YXRlIGg6IEdlc3R1cmVIYW5kbGVyO1xuICAgIHByaXZhdGUgYWRkVGFwOiBBY3RpdmVUYXAgfCBudWxsO1xuICAgIHByaXZhdGUgdGFwczogTWFwPG51bWJlciwgQWN0aXZlVGFwPjtcbiAgICBwcml2YXRlIHBhbjogQWN0aXZlUGFuO1xuXG4gICAgcHJpdmF0ZSBlbmRUYXAodGFwOiBBY3RpdmVUYXAsIGlkOiBudW1iZXIpIHtcbiAgICAgICAgdGhpcy50YXBzLmRlbGV0ZShpZCk7XG4gICAgICAgIHRhcC5hY3RpdmUuZGVsZXRlKGlkKTtcbiAgICAgICAgdGFwLnBvc2l0aW9ucy5kZWxldGUoaWQpO1xuICAgICAgICBpZiAodGhpcy5hZGRUYXAgPT09IHRhcCkge1xuICAgICAgICAgICAgdGhpcy5hZGRUYXAgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0YXAuYWN0aXZlLnNpemUgPT09IDApIHtcbiAgICAgICAgICAgIGNvbnN0IHBvc2l0aW9ucyA9IFtdO1xuICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHRhcC5wb3NpdGlvbnMudmFsdWVzKCkpIHtcbiAgICAgICAgICAgICAgICBwb3NpdGlvbnMucHVzaChwLnN0YXJ0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuaC50YXAocG9zaXRpb25zKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGg6IEdlc3R1cmVIYW5kbGVyKSB7XG4gICAgICAgIHRoaXMuaCA9IGg7XG4gICAgICAgIHRoaXMuYWRkVGFwID0gbnVsbDtcbiAgICAgICAgdGhpcy50YXBzID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLnBhbiA9IG5ldyBNYXAoKTtcbiAgICB9XG5cbiAgICBzdGFydCh0OiBUb3VjaCkge1xuICAgICAgICBpZiAodGhpcy50YXBzLmhhcyh0LmlkZW50aWZpZXIpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUb3VjaCBzdGFydCBvbiBhbHJlYWR5IHRyYWNrZWQgdGFwXCIpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmFkZFRhcCA9PT0gbnVsbCkge1xuICAgICAgICAgICAgLy8gSWYgbm8gdGFwcyBhcmUgYWN0aXZlLCBzZXQgdXAgYSB0YXAgdG8gYWRkIGEgdG91Y2ggdG8uXG4gICAgICAgICAgICB0aGlzLmFkZFRhcCA9IHtcbiAgICAgICAgICAgICAgICBhY3RpdmU6IG5ldyBTZXQoKSxcbiAgICAgICAgICAgICAgICBwb3NpdGlvbnM6IG5ldyBNYXAoKSxcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5hZGRUYXAuYWN0aXZlLmFkZCh0LmlkZW50aWZpZXIpO1xuICAgICAgICBjb25zdCBwb3M6IFBvaW50MkQgPSBbdC5jbGllbnRYLCB0LmNsaWVudFldO1xuICAgICAgICB0aGlzLmFkZFRhcC5wb3NpdGlvbnMuc2V0KHQuaWRlbnRpZmllciwge1xuICAgICAgICAgICAgY3VycjogcG9zLFxuICAgICAgICAgICAgc3RhcnQ6IHBvcyxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudGFwcy5zZXQodC5pZGVudGlmaWVyLCB0aGlzLmFkZFRhcCk7XG4gICAgfVxuXG4gICAgbW92ZSh0czogVG91Y2hMaXN0KSB7XG4gICAgICAgIGxldCBwYW5Nb3ZlZCA9IGZhbHNlO1xuICAgICAgICBmb3IgKGNvbnN0IHQgb2YgdHMpIHtcbiAgICAgICAgICAgIGNvbnN0IHRhcCA9IHRoaXMudGFwcy5nZXQodC5pZGVudGlmaWVyKTtcbiAgICAgICAgICAgIGlmICh0YXAgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBvcyA9IHRhcC5wb3NpdGlvbnMuZ2V0KHQuaWRlbnRpZmllcik7XG4gICAgICAgICAgICAgICAgaWYgKHBvcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRvdWNoIGluIHRhcHMsIGJ1dCBub3QgcG9zaXRpb25zXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBwb3MuY3VyciA9IFt0LmNsaWVudFgsIHQuY2xpZW50WV07XG4gICAgICAgICAgICAgICAgaWYgKDE2IDw9IHBvaW50RGlzdGFuY2UocG9zLmN1cnIsIHBvcy5zdGFydCkpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gVGFwIGhhcyBtb3ZlZCBlbm91Z2ggdG8gYmUgYSBwYW4gaW5zdGVhZC5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbmRUYXAodGFwLCB0LmlkZW50aWZpZXIpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnBhbi5zZXQodC5pZGVudGlmaWVyLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyOiBwb3MuY3VycixcbiAgICAgICAgICAgICAgICAgICAgICAgIHByZXY6IHBvcy5zdGFydCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0OiBwb3Muc3RhcnQsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBwYW5Nb3ZlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwb3MgPSB0aGlzLnBhbi5nZXQodC5pZGVudGlmaWVyKTtcbiAgICAgICAgICAgICAgICBpZiAocG9zID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVG91Y2ggbm90IGluIHRhcHMgb3IgcGFuc1wiKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcG9zLnByZXYgPSBwb3MuY3VycjtcbiAgICAgICAgICAgICAgICBwb3MuY3VyciA9IFt0LmNsaWVudFgsIHQuY2xpZW50WV07XG4gICAgICAgICAgICAgICAgaWYgKCFwb2ludEVxdWFscyhwb3MucHJldiwgcG9zLmN1cnIpKSB7XG4gICAgICAgICAgICAgICAgICAgIHBhbk1vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBhbk1vdmVkKSB7XG4gICAgICAgICAgICBjb25zdCBwb3NpdGlvbnMgPSBbXTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiB0aGlzLnBhbi52YWx1ZXMoKSkge1xuICAgICAgICAgICAgICAgIHBvc2l0aW9ucy5wdXNoKHApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5oLnBhbihwb3NpdGlvbnMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZW5kKGlkOiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgdGFwID0gdGhpcy50YXBzLmdldChpZCk7XG4gICAgICAgIGlmICh0YXAgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5lbmRUYXAodGFwLCBpZCk7XG4gICAgICAgIH0gZWxzZSBpZiAoIXRoaXMucGFuLmRlbGV0ZShpZCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRvdWNoIGVuZCB0aGF0IHdhcyBub3QgYSB0YXAgb3IgYSBwYW5cIik7XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIENsaXBQb3NpdGlvbiB7XG4gICAgKHBvczogVmlld3BvcnRQb3NpdGlvbik6IFZpZXdwb3J0UG9zaXRpb247XG59XG5cbm5ldyBUb3VjaERlbXV4KGMsIG5ldyBHZXN0dXJlcyh7XG4gICAgdGFwOiAodDogVGFwKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwidGFwOiBcIiwgdCk7XG4gICAgfSxcbiAgICBwYW46IChwOiBQYW4pID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coXCJwYW46IFwiLCBwKTtcbiAgICB9LFxufSkpO1xuXG5jb25zb2xlLmxvZyhcInN0dWZmIGxvYWRlZFwiKTtcbiJdfQ==