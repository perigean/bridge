// viewport.js
//
// Copyright Charles Dick 2020
import { transformTranslateCreate, transformRotate, transformStretch, transformInvert, transformPoint, transformTranslate } from './transform.js';
export const TOP_LEFT = 0;
export const TOP_RIGHT = 1;
export const BOTTOM_LEFT = 2;
export const BOTTOM_RIGHT = 3;
// Viewport keeps track of world <-> screen coordinates
// World coordinates are +x -> right, +y -> up
export class Viewport {
    constructor(ctx, render) {
        this.ctx = ctx;
        this.clearStyle = "white";
        this.render = render;
        this.resize = () => {
            const canvas = this.ctx.canvas;
            const dpr = window.devicePixelRatio;
            canvas.width = canvas.offsetWidth * dpr;
            canvas.height = canvas.offsetHeight * dpr;
            this.setPosition(this.pos);
        };
        const canvas = this.ctx.canvas;
        const dpr = window.devicePixelRatio;
        canvas.width = canvas.offsetWidth * dpr;
        canvas.height = canvas.offsetHeight * dpr;
        // Will be reset in setLocation below.
        this.pos = { pos: [0.0, 0.0], scale: dpr, rotate: 0.0 };
        this.t = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.bounds = [
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
        ];
        this.setPosition(this.pos);
    }
    setClearStyle(clearStyle) {
        this.clearStyle = clearStyle;
        this.redraw();
    }
    setPosition(pos) {
        const canvas = this.ctx.canvas;
        const width = canvas.width;
        const height = canvas.height;
        let t = transformTranslateCreate(-pos.pos[0], -pos.pos[1]);
        t = transformRotate(t, pos.rotate);
        t = transformStretch(t, pos.scale, -pos.scale);
        t = transformTranslate(t, width * 0.5, height * 0.5);
        this.t = t;
        const invt = transformInvert(t);
        this.bounds[0] = transformPoint(invt, [0, 0]);
        this.bounds[1] = transformPoint(invt, [width, 0]);
        this.bounds[2] = transformPoint(invt, [0, height]);
        this.bounds[3] = transformPoint(invt, [width, height]);
        this.pos = pos;
        this.redraw();
    }
    redraw() {
        const ctx = this.ctx;
        if (this.clearStyle !== null) {
            const fillStyle = ctx.fillStyle;
            ctx.fillStyle = this.clearStyle;
            ctx.resetTransform();
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = fillStyle;
        }
        const t = this.t;
        ctx.setTransform(t[0], t[3], t[1], t[4], t[2], t[5]);
        this.render(this.bounds, this.pos.scale, ctx);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdmlld3BvcnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsY0FBYztBQUNkLEVBQUU7QUFDRiw4QkFBOEI7QUFDOUIsT0FBTyxFQUFvQix3QkFBd0IsRUFBRSxlQUFlLEVBQUUsZ0JBQWdCLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxrQkFBa0IsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRW5LLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBRyxDQUFDLENBQUM7QUFDMUIsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQztBQUMzQixNQUFNLENBQUMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQzdCLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxDQUFDLENBQUM7QUFjOUIsdURBQXVEO0FBQ3ZELDhDQUE4QztBQUM5QyxNQUFNLE9BQU8sUUFBUTtJQVdqQixZQUFZLEdBQTZCLEVBQUUsTUFBYztRQUNyRCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDO1FBQzFCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFO1lBQ2YsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7WUFDL0IsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUM7WUFDeEMsTUFBTSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQztZQUMxQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQixDQUFDLENBQUE7UUFDRCxNQUFN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QU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7UUFDckIsSUFBSSxJQUFJLENBQUMsVUFBVSxLQUFLLElBQUksRUFBRTtZQUMxQixNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsU0FBUyxDQUFDO1lBQ2hDLEdBQUcsQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztZQUNoQyxHQUFHLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDckIsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEQsR0FBRyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7U0FDN0I7UUFDRCxNQUFNLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2pCLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDbEQsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdmlld3BvcnQuanNcbi8vXG4vLyBDb3B5cmlnaHQgQ2hhcmxlcyBEaWNrIDIwMjBcbmltcG9ydCB7QWZmaW5lMkQsIFBvaW50MkQsIHRyYW5zZm9ybVRyYW5zbGF0ZUNyZWF0ZSwgdHJhbnNmb3JtUm90YXRlLCB0cmFuc2Zvcm1TdHJldGNoLCB0cmFuc2Zvcm1JbnZlcnQsIHRyYW5zZm9ybVBvaW50LCB0cmFuc2Zvcm1UcmFuc2xhdGV9IGZyb20gJy4vdHJhbnNmb3JtLmpzJztcblxuZXhwb3J0IGNvbnN0IFRPUF9MRUZUID0gMDtcbmV4cG9ydCBjb25zdCBUT1BfUklHSFQgPSAxO1xuZXhwb3J0IGNvbnN0IEJPVFRPTV9MRUZUID0gMjtcbmV4cG9ydCBjb25zdCBCT1RUT01fUklHSFQgPSAzO1xuXG5leHBvcnQgdHlwZSBCb3VuZHMgPSBbUG9pbnQyRCwgUG9pbnQyRCwgUG9pbnQyRCwgUG9pbnQyRF07XG5cbmV4cG9ydCB0eXBlIFZpZXdwb3J0UG9zaXRpb24gPSB7XG4gICAgcG9zOiBQb2ludDJEO1xuICAgIHNjYWxlOiBudW1iZXI7XG4gICAgcm90YXRlOiBudW1iZXI7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlbmRlciB7XG4gICAgKGI6IEJvdW5kcywgczogbnVtYmVyLCBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCk6IHZvaWQ7XG59XG5cbi8vIFZpZXdwb3J0IGtlZXBzIHRyYWNrIG9mIHdvcmxkIDwtPiBzY3JlZW4gY29vcmRpbmF0ZXNcbi8vIFdvcmxkIGNvb3JkaW5hdGVzIGFyZSAreCAtPiByaWdodCwgK3kgLT4gdXBcbmV4cG9ydCBjbGFzcyBWaWV3cG9ydCB7XG4gICAgcmVhZG9ubHkgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XG4gICAgcHJpdmF0ZSBwb3M6IFZpZXdwb3J0UG9zaXRpb247XG4gICAgcHJpdmF0ZSB0OiBBZmZpbmUyRDtcbiAgICBwcml2YXRlIGNsZWFyU3R5bGU6IG51bGwgfCBzdHJpbmcgfCBDYW52YXNHcmFkaWVudCB8IENhbnZhc1BhdHRlcm47XG4gICAgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcjtcbiAgICBwcml2YXRlIGJvdW5kczogQm91bmRzO1xuXG4gICAgLy8gTmVlZHMgdG8gYmUgaG9va2VkIHVwIHRvIERPTSByZXNpemUgbGlzdGVuZXJcbiAgICByZXNpemU6ICgpID0+IHZvaWQ7XG5cbiAgICBjb25zdHJ1Y3RvcihjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgcmVuZGVyOiBSZW5kZXIpIHtcbiAgICAgICAgdGhpcy5jdHggPSBjdHg7XG4gICAgICAgIHRoaXMuY2xlYXJTdHlsZSA9IFwid2hpdGVcIjtcbiAgICAgICAgdGhpcy5yZW5kZXIgPSByZW5kZXI7XG4gICAgICAgIHRoaXMucmVzaXplID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICAgICAgY29uc3QgZHByID0gd2luZG93LmRldmljZVBpeGVsUmF0aW87XG4gICAgICAgICAgICBjYW52YXMud2lkdGggPSBjYW52YXMub2Zmc2V0V2lkdGggKiBkcHI7XG4gICAgICAgICAgICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzLm9mZnNldEhlaWdodCAqIGRwcjtcbiAgICAgICAgICAgIHRoaXMuc2V0UG9zaXRpb24odGhpcy5wb3MpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuY3R4LmNhbnZhcztcbiAgICAgICAgY29uc3QgZHByID0gd2luZG93LmRldmljZVBpeGVsUmF0aW87XG4gICAgICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5vZmZzZXRXaWR0aCAqIGRwcjtcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5vZmZzZXRIZWlnaHQgKiBkcHI7XG5cbiAgICAgICAgLy8gV2lsbCBiZSByZXNldCBpbiBzZXRMb2NhdGlvbiBiZWxvdy5cbiAgICAgICAgdGhpcy5wb3MgPSB7cG9zOiBbMC4wLCAwLjBdLCBzY2FsZTogZHByLCByb3RhdGU6IDAuMH07XG4gICAgICAgIHRoaXMudCA9IFswLjAsIDAuMCwgMC4wLCAwLjAsIDAuMCwgMC4wXTtcbiAgICAgICAgdGhpcy5ib3VuZHMgPSBbXG4gICAgICAgICAgICBbMC4wLCAwLjBdLFxuICAgICAgICAgICAgWzAuMCwgMC4wXSxcbiAgICAgICAgICAgIFswLjAsIDAuMF0sXG4gICAgICAgICAgICBbMC4wLCAwLjBdLFxuICAgICAgICBdO1xuICAgICAgICB0aGlzLnNldFBvc2l0aW9uKHRoaXMucG9zKTtcbiAgICB9XG5cbiAgICBzZXRDbGVhclN0eWxlKGNsZWFyU3R5bGU6IG51bGwgfCBzdHJpbmcgfCBDYW52YXNHcmFkaWVudCB8IENhbnZhc1BhdHRlcm4pIHtcbiAgICAgICAgdGhpcy5jbGVhclN0eWxlID0gY2xlYXJTdHlsZTtcbiAgICAgICAgdGhpcy5yZWRyYXcoKTtcbiAgICB9XG5cbiAgICBzZXRQb3NpdGlvbihwb3M6IFZpZXdwb3J0UG9zaXRpb24pIHtcbiAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICBjb25zdCB3aWR0aCA9IGNhbnZhcy53aWR0aDtcbiAgICAgICAgY29uc3QgaGVpZ2h0ID0gY2FudmFzLmhlaWdodDtcbiAgICAgICAgbGV0IHQgPSB0cmFuc2Zvcm1UcmFuc2xhdGVDcmVhdGUoLXBvcy5wb3NbMF0sIC1wb3MucG9zWzFdKTtcbiAgICAgICAgdCA9IHRyYW5zZm9ybVJvdGF0ZSh0LCBwb3Mucm90YXRlKTtcbiAgICAgICAgdCA9IHRyYW5zZm9ybVN0cmV0Y2godCwgcG9zLnNjYWxlLCAtcG9zLnNjYWxlKTtcbiAgICAgICAgdCA9IHRyYW5zZm9ybVRyYW5zbGF0ZSh0LCB3aWR0aCAqIDAuNSwgaGVpZ2h0ICogMC41KTtcbiAgICAgICAgdGhpcy50ID0gdDtcblxuICAgICAgICBjb25zdCBpbnZ0ID0gdHJhbnNmb3JtSW52ZXJ0KHQpO1xuICAgICAgICB0aGlzLmJvdW5kc1swXSA9IHRyYW5zZm9ybVBvaW50KGludnQsIFswLCAwXSk7XG4gICAgICAgIHRoaXMuYm91bmRzWzFdID0gdHJhbnNmb3JtUG9pbnQoaW52dCwgW3dpZHRoLCAwXSk7XG4gICAgICAgIHRoaXMuYm91bmRzWzJdID0gdHJhbnNmb3JtUG9pbnQoaW52dCwgWzAsIGhlaWdodF0pO1xuICAgICAgICB0aGlzLmJvdW5kc1szXSA9IHRyYW5zZm9ybVBvaW50KGludnQsIFt3aWR0aCwgaGVpZ2h0XSk7XG4gICAgICAgIHRoaXMucG9zID0gcG9zO1xuICAgICAgICB0aGlzLnJlZHJhdygpO1xuICAgIH1cblxuICAgIHJlZHJhdygpIHtcbiAgICAgICAgY29uc3QgY3R4ID0gdGhpcy5jdHg7XG4gICAgICAgIGlmICh0aGlzLmNsZWFyU3R5bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGxTdHlsZSA9IGN0eC5maWxsU3R5bGU7XG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gdGhpcy5jbGVhclN0eWxlO1xuICAgICAgICAgICAgY3R4LnJlc2V0VHJhbnNmb3JtKCk7XG4gICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgY3R4LmNhbnZhcy53aWR0aCwgY3R4LmNhbnZhcy5oZWlnaHQpO1xuICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGZpbGxTdHlsZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0ID0gdGhpcy50O1xuICAgICAgICBjdHguc2V0VHJhbnNmb3JtKHRbMF0sIHRbM10sIHRbMV0sIHRbNF0sIHRbMl0sIHRbNV0pO1xuICAgICAgICB0aGlzLnJlbmRlcih0aGlzLmJvdW5kcywgdGhpcy5wb3Muc2NhbGUsIGN0eCk7XG4gICAgfVxuXG59XG4iXX0=