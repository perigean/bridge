import { transformTranslateCreate, transformRotate, transformStretch, transformInvert, transformPoint, transformTranslate } from './transform.js';
export const TOP_LEFT = 0;
export const TOP_RIGHT = 1;
export const BOTTOM_LEFT = 2;
export const BOTTOM_RIGHT = 3;
// Viewport keeps track of world <-> screen coordinates
// World coordinates are +x -> right, +y -> up
export class Viewport {
    constructor(ctx, render) {
        this.ctx = ctx;
        this.clearStyle = "white";
        this.render = render;
        this.resize = () => {
            const canvas = this.ctx.canvas;
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            this.setPosition(this.pos);
        };
        const canvas = this.ctx.canvas;
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        // Will be reset in setLocation below.
        this.pos = { pos: [0.0, 0.0], scale: 1.0, rotate: 0.0 };
        this.t = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.invt = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.bounds = [
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
        ];
        this.setPosition(this.pos);
    }
    setClearStyle(clearStyle) {
        this.clearStyle = clearStyle;
        this.redraw();
    }
    setPosition(pos) {
        if (pos.pos !== undefined) {
            this.pos.pos = pos.pos;
        }
        if (pos.rotate !== undefined) {
            this.pos.rotate = pos.rotate;
        }
        if (pos.scale !== undefined) {
            this.pos.scale = pos.scale;
        }
        const canvas = this.ctx.canvas;
        const width = canvas.width;
        const height = canvas.height;
        let t = transformTranslateCreate(-this.pos.pos[0], -this.pos.pos[1]);
        t = transformRotate(t, this.pos.rotate);
        t = transformStretch(t, this.pos.scale, -this.pos.scale);
        t = transformTranslate(t, width * 0.5, height * 0.5);
        this.t = t;
        const invt = transformInvert(t);
        this.bounds[0] = transformPoint(invt, [0, 0]);
        this.bounds[1] = transformPoint(invt, [width, 0]);
        this.bounds[2] = transformPoint(invt, [0, height]);
        this.bounds[3] = transformPoint(invt, [width, height]);
        this.invt = invt;
        this.redraw();
    }
    position() {
        return this.pos;
    }
    screen2world() {
        return this.invt;
    }
    world2screen() {
        return this.t;
    }
    redraw() {
        const ctx = this.ctx;
        if (this.clearStyle !== null) {
            const fillStyle = ctx.fillStyle;
            ctx.fillStyle = this.clearStyle;
            ctx.resetTransform();
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = fillStyle;
        }
        const t = this.t;
        ctx.setTransform(t[0], t[3], t[1], t[4], t[2], t[5]);
        this.render(this.bounds, this.pos.scale, ctx);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdmlld3BvcnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUFZLHdCQUF3QixFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFNUosTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUFHLENBQUMsQ0FBQztBQUMxQixNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0FBQzNCLE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFDN0IsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLENBQUMsQ0FBQztBQWM5Qix1REFBdUQ7QUFDdkQsOENBQThDO0FBQzlDLE1BQU0sT0FBTyxRQUFRO0lBWWpCLFlBQVksR0FBNkIsRUFBRSxNQUFjO1FBQ3JELElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUM7UUFDMUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDZixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztZQUMvQixNQUFNLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUM7WUFDbEMsTUFBTSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDO1lBQ3BDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9CLENBQUMsQ0FBQTtRQUNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDO1FBQy9CLE1BQU0sQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztRQUNsQyxNQUFN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QyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNsRCxDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB2aWV3cG9ydC5qc1xuLy9cbi8vIENvcHlyaWdodCBDaGFybGVzIERpY2sgMjAyMFxuaW1wb3J0IHsgUG9pbnQyRCB9IGZyb20gXCIuL3BvaW50LmpzXCJcbmltcG9ydCB7IEFmZmluZTJELCB0cmFuc2Zvcm1UcmFuc2xhdGVDcmVhdGUsIHRyYW5zZm9ybVJvdGF0ZSwgdHJhbnNmb3JtU3RyZXRjaCwgdHJhbnNmb3JtSW52ZXJ0LCB0cmFuc2Zvcm1Qb2ludCwgdHJhbnNmb3JtVHJhbnNsYXRlIH0gZnJvbSAnLi90cmFuc2Zvcm0uanMnO1xuXG5leHBvcnQgY29uc3QgVE9QX0xFRlQgPSAwO1xuZXhwb3J0IGNvbnN0IFRPUF9SSUdIVCA9IDE7XG5leHBvcnQgY29uc3QgQk9UVE9NX0xFRlQgPSAyO1xuZXhwb3J0IGNvbnN0IEJPVFRPTV9SSUdIVCA9IDM7XG5cbmV4cG9ydCB0eXBlIEJvdW5kcyA9IFtQb2ludDJELCBQb2ludDJELCBQb2ludDJELCBQb2ludDJEXTtcblxuZXhwb3J0IHR5cGUgVmlld3BvcnRQb3NpdGlvbiA9IHtcbiAgICBwb3M6IFBvaW50MkQ7XG4gICAgc2NhbGU6IG51bWJlcjtcbiAgICByb3RhdGU6IG51bWJlcjtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVuZGVyIHtcbiAgICAoYjogQm91bmRzLCBzOiBudW1iZXIsIGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEKTogdm9pZDtcbn1cblxuLy8gVmlld3BvcnQga2VlcHMgdHJhY2sgb2Ygd29ybGQgPC0+IHNjcmVlbiBjb29yZGluYXRlc1xuLy8gV29ybGQgY29vcmRpbmF0ZXMgYXJlICt4IC0+IHJpZ2h0LCAreSAtPiB1cFxuZXhwb3J0IGNsYXNzIFZpZXdwb3J0IHtcbiAgICByZWFkb25seSBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRDtcbiAgICBwcml2YXRlIHBvczogVmlld3BvcnRQb3NpdGlvbjtcbiAgICBwcml2YXRlIHQ6IEFmZmluZTJEO1xuICAgIHByaXZhdGUgaW52dDogQWZmaW5lMkQ7XG4gICAgcHJpdmF0ZSBjbGVhclN0eWxlOiBudWxsIHwgc3RyaW5nIHwgQ2FudmFzR3JhZGllbnQgfCBDYW52YXNQYXR0ZXJuO1xuICAgIHByaXZhdGUgcmVuZGVyOiBSZW5kZXI7XG4gICAgcHJpdmF0ZSBib3VuZHM6IEJvdW5kcztcblxuICAgIC8vIE5lZWRzIHRvIGJlIGhvb2tlZCB1cCB0byBET00gcmVzaXplIGxpc3RlbmVyXG4gICAgcmVzaXplOiAoKSA9PiB2b2lkO1xuXG4gICAgY29uc3RydWN0b3IoY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsIHJlbmRlcjogUmVuZGVyKSB7XG4gICAgICAgIHRoaXMuY3R4ID0gY3R4O1xuICAgICAgICB0aGlzLmNsZWFyU3R5bGUgPSBcIndoaXRlXCI7XG4gICAgICAgIHRoaXMucmVuZGVyID0gcmVuZGVyO1xuICAgICAgICB0aGlzLnJlc2l6ZSA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuY3R4LmNhbnZhcztcbiAgICAgICAgICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5vZmZzZXRXaWR0aDtcbiAgICAgICAgICAgIGNhbnZhcy5oZWlnaHQgPSBjYW52YXMub2Zmc2V0SGVpZ2h0O1xuICAgICAgICAgICAgdGhpcy5zZXRQb3NpdGlvbih0aGlzLnBvcyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICBjYW52YXMud2lkdGggPSBjYW52YXMub2Zmc2V0V2lkdGg7XG4gICAgICAgIGNhbnZhcy5oZWlnaHQgPSBjYW52YXMub2Zmc2V0SGVpZ2h0O1xuXG4gICAgICAgIC8vIFdpbGwgYmUgcmVzZXQgaW4gc2V0TG9jYXRpb24gYmVsb3cuXG4gICAgICAgIHRoaXMucG9zID0geyBwb3M6IFswLjAsIDAuMF0sIHNjYWxlOiAxLjAsIHJvdGF0ZTogMC4wIH07XG4gICAgICAgIHRoaXMudCA9IFswLjAsIDAuMCwgMC4wLCAwLjAsIDAuMCwgMC4wXTtcbiAgICAgICAgdGhpcy5pbnZ0ID0gWzAuMCwgMC4wLCAwLjAsIDAuMCwgMC4wLCAwLjBdO1xuICAgICAgICB0aGlzLmJvdW5kcyA9IFtcbiAgICAgICAgICAgIFswLjAsIDAuMF0sXG4gICAgICAgICAgICBbMC4wLCAwLjBdLFxuICAgICAgICAgICAgWzAuMCwgMC4wXSxcbiAgICAgICAgICAgIFswLjAsIDAuMF0sXG4gICAgICAgIF07XG4gICAgICAgIHRoaXMuc2V0UG9zaXRpb24odGhpcy5wb3MpO1xuICAgIH1cblxuICAgIHNldENsZWFyU3R5bGUoY2xlYXJTdHlsZTogbnVsbCB8IHN0cmluZyB8IENhbnZhc0dyYWRpZW50IHwgQ2FudmFzUGF0dGVybikge1xuICAgICAgICB0aGlzLmNsZWFyU3R5bGUgPSBjbGVhclN0eWxlO1xuICAgICAgICB0aGlzLnJlZHJhdygpO1xuICAgIH1cblxuICAgIHNldFBvc2l0aW9uKHBvczogUGFydGlhbDxWaWV3cG9ydFBvc2l0aW9uPikge1xuICAgICAgICBpZiAocG9zLnBvcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLnBvcy5wb3MgPSBwb3MucG9zO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwb3Mucm90YXRlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMucG9zLnJvdGF0ZSA9IHBvcy5yb3RhdGU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBvcy5zY2FsZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLnBvcy5zY2FsZSA9IHBvcy5zY2FsZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjYW52YXMgPSB0aGlzLmN0eC5jYW52YXM7XG4gICAgICAgIGNvbnN0IHdpZHRoID0gY2FudmFzLndpZHRoO1xuICAgICAgICBjb25zdCBoZWlnaHQgPSBjYW52YXMuaGVpZ2h0O1xuICAgICAgICBsZXQgdCA9IHRyYW5zZm9ybVRyYW5zbGF0ZUNyZWF0ZSgtdGhpcy5wb3MucG9zWzBdLCAtdGhpcy5wb3MucG9zWzFdKTtcbiAgICAgICAgdCA9IHRyYW5zZm9ybVJvdGF0ZSh0LCB0aGlzLnBvcy5yb3RhdGUpO1xuICAgICAgICB0ID0gdHJhbnNmb3JtU3RyZXRjaCh0LCB0aGlzLnBvcy5zY2FsZSwgLXRoaXMucG9zLnNjYWxlKTtcbiAgICAgICAgdCA9IHRyYW5zZm9ybVRyYW5zbGF0ZSh0LCB3aWR0aCAqIDAuNSwgaGVpZ2h0ICogMC41KTtcbiAgICAgICAgdGhpcy50ID0gdDtcblxuICAgICAgICBjb25zdCBpbnZ0ID0gdHJhbnNmb3JtSW52ZXJ0KHQpO1xuICAgICAgICB0aGlzLmJvdW5kc1swXSA9IHRyYW5zZm9ybVBvaW50KGludnQsIFswLCAwXSk7XG4gICAgICAgIHRoaXMuYm91bmRzWzFdID0gdHJhbnNmb3JtUG9pbnQoaW52dCwgW3dpZHRoLCAwXSk7XG4gICAgICAgIHRoaXMuYm91bmRzWzJdID0gdHJhbnNmb3JtUG9pbnQoaW52dCwgWzAsIGhlaWdodF0pO1xuICAgICAgICB0aGlzLmJvdW5kc1szXSA9IHRyYW5zZm9ybVBvaW50KGludnQsIFt3aWR0aCwgaGVpZ2h0XSk7XG4gICAgICAgIHRoaXMuaW52dCA9IGludnQ7XG4gICAgICAgIHRoaXMucmVkcmF3KCk7XG4gICAgfVxuXG4gICAgcG9zaXRpb24oKTogUmVhZG9ubHk8Vmlld3BvcnRQb3NpdGlvbj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wb3M7XG4gICAgfVxuXG4gICAgc2NyZWVuMndvcmxkKCk6IFJlYWRvbmx5PEFmZmluZTJEPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmludnQ7XG4gICAgfVxuXG4gICAgd29ybGQyc2NyZWVuKCk6IFJlYWRvbmx5PEFmZmluZTJEPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnQ7XG4gICAgfVxuXG4gICAgcmVkcmF3KCkge1xuICAgICAgICBjb25zdCBjdHggPSB0aGlzLmN0eDtcbiAgICAgICAgaWYgKHRoaXMuY2xlYXJTdHlsZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgY29uc3QgZmlsbFN0eWxlID0gY3R4LmZpbGxTdHlsZTtcbiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmNsZWFyU3R5bGU7XG4gICAgICAgICAgICBjdHgucmVzZXRUcmFuc2Zvcm0oKTtcbiAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBjdHguY2FudmFzLndpZHRoLCBjdHguY2FudmFzLmhlaWdodCk7XG4gICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZmlsbFN0eWxlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHQgPSB0aGlzLnQ7XG4gICAgICAgIGN0eC5zZXRUcmFuc2Zvcm0odFswXSwgdFszXSwgdFsxXSwgdFs0XSwgdFsyXSwgdFs1XSk7XG4gICAgICAgIHRoaXMucmVuZGVyKHRoaXMuYm91bmRzLCB0aGlzLnBvcy5zY2FsZSwgY3R4KTtcbiAgICB9XG5cbn1cbiJdfQ==