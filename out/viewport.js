// Copyright Charles Dueck 2020
import { pointAdd, pointSub, pointAngle, pointDistance } from "./point.js";
import { transformTranslateCreate, transformRotate, transformStretch, transformInvert, transformPoint, transformTranslate, transformScale } from './transform.js';
export const TOP_LEFT = 0;
export const TOP_RIGHT = 1;
export const BOTTOM_LEFT = 2;
export const BOTTOM_RIGHT = 3;
// Viewport keeps track of world <-> screen coordinates
// World coordinates are +x -> right, +y -> up
export class Viewport {
    constructor(ctx, render) {
        this.ctx = ctx;
        this.clearStyle = "white";
        this.posClipper = null;
        this.render = render;
        this.recentRedraw = false;
        this.redrawRequested = false;
        this.redraw = () => {
            this.recentRedraw = true;
            requestAnimationFrame(this.clearRecentRedraw);
            const ctx = this.ctx;
            if (this.clearStyle !== null) {
                const fillStyle = ctx.fillStyle;
                ctx.fillStyle = this.clearStyle;
                ctx.resetTransform();
                ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = fillStyle;
            }
            const t = this.w2c;
            ctx.setTransform(t[0], t[3], t[1], t[4], t[2], t[5]);
            this.render(this.bounds, this.pos.scale, ctx);
        };
        this.clearRecentRedraw = () => {
            const requested = this.redrawRequested;
            this.recentRedraw = false;
            this.redrawRequested = false;
            if (requested) {
                this.redraw();
            }
        };
        this.resize = () => {
            const canvas = this.ctx.canvas;
            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            this.setPosition(this.pos);
        };
        const canvas = this.ctx.canvas;
        canvas.width = canvas.offsetWidth * window.devicePixelRatio;
        canvas.height = canvas.offsetHeight * window.devicePixelRatio;
        // Will be reset in setLocation below.
        this.pos = { pos: [0.0, 0.0], scale: 1.0, rotate: 0.0 };
        this.s2w = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.w2c = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.w2s = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.bounds = [
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
        ];
        this.setPosition(this.pos);
    }
    requestRedraw() {
        if (this.recentRedraw) {
            this.redrawRequested = true;
        }
        else {
            this.redraw();
        }
    }
    setClearStyle(clearStyle) {
        this.clearStyle = clearStyle;
        this.requestRedraw();
    }
    setClipPosition(clip) {
        this.posClipper = clip;
    }
    setPosition(pos) {
        if (pos.pos !== undefined) {
            this.pos.pos = pos.pos;
        }
        if (pos.rotate !== undefined) {
            if (pos.rotate >= Math.PI) {
                this.pos.rotate = pos.rotate - Math.floor(pos.rotate / (2.0 * Math.PI)) * 2.0 * Math.PI;
            }
            else if (pos.rotate < -Math.PI) {
                this.pos.rotate = pos.rotate - Math.ceil(pos.rotate / (2.0 * Math.PI)) * 2.0 * Math.PI;
            }
            else {
                this.pos.rotate = pos.rotate;
            }
        }
        if (pos.scale !== undefined) {
            this.pos.scale = pos.scale;
        }
        if (this.posClipper !== null) {
            this.pos = this.posClipper(this.pos);
        }
        const canvas = this.ctx.canvas;
        const dpr = window.devicePixelRatio;
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;
        let w2 = transformTranslateCreate(-this.pos.pos[0], -this.pos.pos[1]);
        w2 = transformRotate(w2, this.pos.rotate);
        w2 = transformStretch(w2, this.pos.scale, -this.pos.scale);
        w2 = transformTranslate(w2, width * 0.5, height * 0.5);
        this.w2s = w2;
        w2 = transformScale(w2, dpr);
        this.w2c = w2;
        const s2w = transformInvert(this.w2s);
        this.bounds[0] = transformPoint(s2w, [0, 0]);
        this.bounds[1] = transformPoint(s2w, [width, 0]);
        this.bounds[2] = transformPoint(s2w, [0, height]);
        this.bounds[3] = transformPoint(s2w, [width, height]);
        this.s2w = s2w;
        this.requestRedraw();
    }
    position() {
        return this.pos;
    }
    screen2world() {
        return this.s2w;
    }
    world2screen() {
        return this.w2s;
    }
}
export class PanGesture {
    constructor(vp) {
        this.vp = vp;
    }
    tap(_t) { }
    pan(ps) {
        if (ps.length != 1) {
            return;
        }
        const pos = this.vp.position();
        const s2w = this.vp.screen2world();
        const p = ps[ps.length - 1];
        const curr = transformPoint(s2w, p.curr);
        const prev = transformPoint(s2w, p.prev);
        this.vp.setPosition({
            pos: pointAdd(pos.pos, pointSub(prev, curr)),
        });
    }
}
export class PinchZoomGesture {
    constructor(vp) {
        this.vp = vp;
    }
    tap(_t) { }
    pan(ps) {
        if (ps.length < 2) {
            return;
        }
        const pos = this.vp.position();
        const s2w = this.vp.screen2world();
        const p1 = ps[ps.length - 1];
        const p2 = ps[ps.length - 2];
        const wp1prev = transformPoint(s2w, p1.prev);
        const curra = pointAngle(pointSub(p2.curr, p1.curr));
        const preva = pointAngle(pointSub(p2.prev, p1.prev));
        const currl = pointDistance(p1.curr, p2.curr);
        const prevl = pointDistance(p1.prev, p2.prev);
        const wp1curr = transformPoint(s2w, p1.curr);
        let t = transformTranslateCreate(-wp1curr[0], -wp1curr[1]);
        t = transformScale(t, prevl / currl);
        t = transformRotate(t, preva - curra);
        t = transformTranslate(t, wp1prev[0], wp1prev[1]);
        // TODO: why does this work? Isn't it backwards?
        this.vp.setPosition({
            pos: transformPoint(t, pos.pos),
            scale: pos.scale * currl / prevl,
            rotate: pos.rotate - preva + curra,
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdmlld3BvcnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsK0JBQStCO0FBRS9CLE9BQU8sRUFBVyxRQUFRLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsTUFBTSxZQUFZLENBQUE7QUFDbkYsT0FBTyxFQUFZLHdCQUF3QixFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzVLLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBRyxDQUFDLENBQUM7QUFDMUIsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQztBQUMzQixNQUFNLENBQUMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQzdCLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxDQUFDLENBQUM7QUFrQjlCLHVEQUF1RDtBQUN2RCw4Q0FBOEM7QUFDOUMsTUFBTSxPQUFPLFFBQVE7SUE0QmpCLFlBQVksR0FBNkIsRUFBRSxNQUFjO1FBQ3JELElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUM7UUFDMUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7UUFDMUIsSUFBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7UUFDN0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDZixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztZQUN6QixxQkFBcUIsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUM5QyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMs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LGVBQWUsQ0FBQyxDQUFDLEVBQUUsS0FBSyxHQUFHLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLENBQUMsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2xELGdEQUFnRDtRQUVoRCxJQUFJLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQztZQUNoQixHQUFHLEVBQUUsY0FBYyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDO1lBQy9CLEtBQUssRUFBRSxHQUFHLENBQUMsS0FBSyxHQUFHLEtBQUssR0FBRyxLQUFLO1lBQ2hDLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTSxHQUFHLEtBQUssR0FBRyxLQUFLO1NBQ3JDLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCBDaGFybGVzIER1ZWNrIDIwMjBcblxuaW1wb3J0IHsgUG9pbnQyRCwgcG9pbnRBZGQsIHBvaW50U3ViLCBwb2ludEFuZ2xlLCBwb2ludERpc3RhbmNlIH0gZnJvbSBcIi4vcG9pbnQuanNcIlxuaW1wb3J0IHsgQWZmaW5lMkQsIHRyYW5zZm9ybVRyYW5zbGF0ZUNyZWF0ZSwgdHJhbnNmb3JtUm90YXRlLCB0cmFuc2Zvcm1TdHJldGNoLCB0cmFuc2Zvcm1JbnZlcnQsIHRyYW5zZm9ybVBvaW50LCB0cmFuc2Zvcm1UcmFuc2xhdGUsIHRyYW5zZm9ybVNjYWxlIH0gZnJvbSAnLi90cmFuc2Zvcm0uanMnO1xuaW1wb3J0IHsgR2VzdHVyZUhhbmRsZXIsIFRhcCwgUGFuIH0gZnJvbSBcIi4vZ2VzdHVyZS5qc1wiO1xuXG5leHBvcnQgY29uc3QgVE9QX0xFRlQgPSAwO1xuZXhwb3J0IGNvbnN0IFRPUF9SSUdIVCA9IDE7XG5leHBvcnQgY29uc3QgQk9UVE9NX0xFRlQgPSAyO1xuZXhwb3J0IGNvbnN0IEJPVFRPTV9SSUdIVCA9IDM7XG5cbmV4cG9ydCB0eXBlIEJvdW5kcyA9IFtQb2ludDJELCBQb2ludDJELCBQb2ludDJELCBQb2ludDJEXTtcblxuZXhwb3J0IHR5cGUgVmlld3BvcnRQb3NpdGlvbiA9IHtcbiAgICBwb3M6IFBvaW50MkQ7XG4gICAgc2NhbGU6IG51bWJlcjtcbiAgICByb3RhdGU6IG51bWJlcjtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2xpcFBvc2l0aW9uIHtcbiAgICAocG9zOiBWaWV3cG9ydFBvc2l0aW9uKTogVmlld3BvcnRQb3NpdGlvbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZW5kZXIge1xuICAgIChiOiBCb3VuZHMsIHM6IG51bWJlciwgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQpOiB2b2lkO1xufVxuXG4vLyBWaWV3cG9ydCBrZWVwcyB0cmFjayBvZiB3b3JsZCA8LT4gc2NyZWVuIGNvb3JkaW5hdGVzXG4vLyBXb3JsZCBjb29yZGluYXRlcyBhcmUgK3ggLT4gcmlnaHQsICt5IC0+IHVwXG5leHBvcnQgY2xhc3MgVmlld3BvcnQge1xuICAgIHJlYWRvbmx5IGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEO1xuICAgIHByaXZhdGUgcG9zOiBWaWV3cG9ydFBvc2l0aW9uO1xuICAgIHByaXZhdGUgdzJjOiBBZmZpbmUyRDsgIC8vIFdvcmxkIHRvIGNhbnZhcyB0cmFuc2Zvcm1cbiAgICBwcml2YXRlIHcyczogQWZmaW5lMkQ7ICAvLyBXb3JsZCB0byBzY3JlZW4gdHJhbnNmb3JtLCBkaWZmZXJlbnQgZnJvbSB3MmMgaWYgd2luZG93LmRldmljZVBpeGVsUmF0aW8gIT0gMVxuICAgIHByaXZhdGUgczJ3OiBBZmZpbmUyRDsgIC8vIFNjcmVlbiB0byB3b3JsZCB0cmFuc2Zvcm1cbiAgICBwcml2YXRlIGNsZWFyU3R5bGU6IG51bGwgfCBzdHJpbmcgfCBDYW52YXNHcmFkaWVudCB8IENhbnZhc1BhdHRlcm47XG4gICAgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcjtcbiAgICBwcml2YXRlIGJvdW5kczogQm91bmRzO1xuICAgIC8vIE5lZWRzIHRvIGJlIGhvb2tlZCB1cCB0byBET00gcmVzaXplIGxpc3RlbmVyXG4gICAgcmVzaXplOiAoKSA9PiB2b2lkO1xuXG4gICAgcHJpdmF0ZSBwb3NDbGlwcGVyOiBDbGlwUG9zaXRpb24gfCBudWxsO1xuXG4gICAgLy8gUmVkcmF3IGRlYm91bmNpbmcgbWV0aG9kc1xuICAgIHByaXZhdGUgcmVkcmF3OiAoKSA9PiB2b2lkO1xuICAgIHByaXZhdGUgY2xlYXJSZWNlbnRSZWRyYXc6ICgpID0+IHZvaWQ7XG4gICAgcHJpdmF0ZSByZWNlbnRSZWRyYXc6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSByZWRyYXdSZXF1ZXN0ZWQ6IGJvb2xlYW47XG5cbiAgICBwcml2YXRlIHJlcXVlc3RSZWRyYXcoKSB7XG4gICAgICAgIGlmICh0aGlzLnJlY2VudFJlZHJhdykge1xuICAgICAgICAgICAgdGhpcy5yZWRyYXdSZXF1ZXN0ZWQgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZWRyYXcoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCByZW5kZXI6IFJlbmRlcikge1xuICAgICAgICB0aGlzLmN0eCA9IGN0eDtcbiAgICAgICAgdGhpcy5jbGVhclN0eWxlID0gXCJ3aGl0ZVwiO1xuICAgICAgICB0aGlzLnBvc0NsaXBwZXIgPSBudWxsO1xuICAgICAgICB0aGlzLnJlbmRlciA9IHJlbmRlcjtcbiAgICAgICAgdGhpcy5yZWNlbnRSZWRyYXcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZWRyYXdSZXF1ZXN0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZWRyYXcgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlY2VudFJlZHJhdyA9IHRydWU7XG4gICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5jbGVhclJlY2VudFJlZHJhdyk7XG4gICAgICAgICAgICBjb25zdCBjdHggPSB0aGlzLmN0eDtcbiAgICAgICAgICAgIGlmICh0aGlzLmNsZWFyU3R5bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxsU3R5bGUgPSBjdHguZmlsbFN0eWxlO1xuICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmNsZWFyU3R5bGU7XG4gICAgICAgICAgICAgICAgY3R4LnJlc2V0VHJhbnNmb3JtKCk7XG4gICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGN0eC5jYW52YXMud2lkdGgsIGN0eC5jYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZmlsbFN0eWxlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMudzJjO1xuICAgICAgICAgICAgY3R4LnNldFRyYW5zZm9ybSh0WzBdLCB0WzNdLCB0WzFdLCB0WzRdLCB0WzJdLCB0WzVdKTtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyKHRoaXMuYm91bmRzLCB0aGlzLnBvcy5zY2FsZSwgY3R4KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNsZWFyUmVjZW50UmVkcmF3ID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdGVkID0gdGhpcy5yZWRyYXdSZXF1ZXN0ZWQ7XG4gICAgICAgICAgICB0aGlzLnJlY2VudFJlZHJhdyA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5yZWRyYXdSZXF1ZXN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChyZXF1ZXN0ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZHJhdygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVzaXplID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICAgICAgY2FudmFzLndpZHRoID0gY2FudmFzLm9mZnNldFdpZHRoICogd2luZG93LmRldmljZVBpeGVsUmF0aW87XG4gICAgICAgICAgICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzLm9mZnNldEhlaWdodCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xuICAgICAgICAgICAgdGhpcy5zZXRQb3NpdGlvbih0aGlzLnBvcyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICBjYW52YXMud2lkdGggPSBjYW52YXMub2Zmc2V0V2lkdGggKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbztcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5vZmZzZXRIZWlnaHQgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbztcblxuICAgICAgICAvLyBXaWxsIGJlIHJlc2V0IGluIHNldExvY2F0aW9uIGJlbG93LlxuICAgICAgICB0aGlzLnBvcyA9IHsgcG9zOiBbMC4wLCAwLjBdLCBzY2FsZTogMS4wLCByb3RhdGU6IDAuMCB9O1xuICAgICAgICB0aGlzLnMydyA9IFswLjAsIDAuMCwgMC4wLCAwLjAsIDAuMCwgMC4wXTtcbiAgICAgICAgdGhpcy53MmMgPSBbMC4wLCAwLjAsIDAuMCwgMC4wLCAwLjAsIDAuMF07XG4gICAgICAgIHRoaXMudzJzID0gWzAuMCwgMC4wLCAwLjAsIDAuMCwgMC4wLCAwLjBdO1xuICAgICAgICB0aGlzLmJvdW5kcyA9IFtcbiAgICAgICAgICAgIFswLjAsIDAuMF0sXG4gICAgICAgICAgICBbMC4wLCAwLjBdLFxuICAgICAgICAgICAgWzAuMCwgMC4wXSxcbiAgICAgICAgICAgIFswLjAsIDAuMF0sXG4gICAgICAgIF07XG4gICAgICAgIHRoaXMuc2V0UG9zaXRpb24odGhpcy5wb3MpO1xuICAgIH1cblxuICAgIHNldENsZWFyU3R5bGUoY2xlYXJTdHlsZTogbnVsbCB8IHN0cmluZyB8IENhbnZhc0dyYWRpZW50IHwgQ2FudmFzUGF0dGVybikge1xuICAgICAgICB0aGlzLmNsZWFyU3R5bGUgPSBjbGVhclN0eWxlO1xuICAgICAgICB0aGlzLnJlcXVlc3RSZWRyYXcoKTtcbiAgICB9XG5cbiAgICBzZXRDbGlwUG9zaXRpb24oY2xpcDogQ2xpcFBvc2l0aW9uKSB7XG4gICAgICAgIHRoaXMucG9zQ2xpcHBlciA9IGNsaXA7XG4gICAgfVxuXG4gICAgc2V0UG9zaXRpb24ocG9zOiBQYXJ0aWFsPFZpZXdwb3J0UG9zaXRpb24+KSB7XG4gICAgICAgIGlmIChwb3MucG9zICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMucG9zLnBvcyA9IHBvcy5wb3M7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBvcy5yb3RhdGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgaWYgKHBvcy5yb3RhdGUgPj0gTWF0aC5QSSkge1xuICAgICAgICAgICAgICAgIHRoaXMucG9zLnJvdGF0ZSA9IHBvcy5yb3RhdGUgLSBNYXRoLmZsb29yKHBvcy5yb3RhdGUgLyAoMi4wICogTWF0aC5QSSkpICogMi4wICogTWF0aC5QSTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocG9zLnJvdGF0ZSA8IC1NYXRoLlBJKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wb3Mucm90YXRlID0gcG9zLnJvdGF0ZSAtIE1hdGguY2VpbChwb3Mucm90YXRlIC8gKDIuMCAqIE1hdGguUEkpKSAqIDIuMCAqIE1hdGguUEk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMucG9zLnJvdGF0ZSA9IHBvcy5yb3RhdGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBvcy5zY2FsZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLnBvcy5zY2FsZSA9IHBvcy5zY2FsZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5wb3NDbGlwcGVyICE9PSBudWxsKSB7XG4gICAgICAgICAgICB0aGlzLnBvcyA9IHRoaXMucG9zQ2xpcHBlcih0aGlzLnBvcyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICBjb25zdCBkcHIgPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbztcbiAgICAgICAgY29uc3Qgd2lkdGggPSBjYW52YXMub2Zmc2V0V2lkdGg7XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IGNhbnZhcy5vZmZzZXRIZWlnaHQ7XG4gICAgICAgIGxldCB3MiA9IHRyYW5zZm9ybVRyYW5zbGF0ZUNyZWF0ZSgtdGhpcy5wb3MucG9zWzBdLCAtdGhpcy5wb3MucG9zWzFdKTtcbiAgICAgICAgdzIgPSB0cmFuc2Zvcm1Sb3RhdGUodzIsIHRoaXMucG9zLnJvdGF0ZSk7XG4gICAgICAgIHcyID0gdHJhbnNmb3JtU3RyZXRjaCh3MiwgdGhpcy5wb3Muc2NhbGUsIC10aGlzLnBvcy5zY2FsZSk7XG4gICAgICAgIHcyID0gdHJhbnNmb3JtVHJhbnNsYXRlKHcyLCB3aWR0aCAqIDAuNSwgaGVpZ2h0ICogMC41KTtcbiAgICAgICAgdGhpcy53MnMgPSB3MjtcbiAgICAgICAgdzIgPSB0cmFuc2Zvcm1TY2FsZSh3MiwgZHByKTtcbiAgICAgICAgdGhpcy53MmMgPSB3MjtcblxuICAgICAgICBjb25zdCBzMncgPSB0cmFuc2Zvcm1JbnZlcnQodGhpcy53MnMpO1xuICAgICAgICB0aGlzLmJvdW5kc1swXSA9IHRyYW5zZm9ybVBvaW50KHMydywgWzAsIDBdKTtcbiAgICAgICAgdGhpcy5ib3VuZHNbMV0gPSB0cmFuc2Zvcm1Qb2ludChzMncsIFt3aWR0aCwgMF0pO1xuICAgICAgICB0aGlzLmJvdW5kc1syXSA9IHRyYW5zZm9ybVBvaW50KHMydywgWzAsIGhlaWdodF0pO1xuICAgICAgICB0aGlzLmJvdW5kc1szXSA9IHRyYW5zZm9ybVBvaW50KHMydywgW3dpZHRoLCBoZWlnaHRdKTtcbiAgICAgICAgdGhpcy5zMncgPSBzMnc7XG4gICAgICAgIHRoaXMucmVxdWVzdFJlZHJhdygpO1xuICAgIH1cblxuICAgIHBvc2l0aW9uKCk6IFJlYWRvbmx5PFZpZXdwb3J0UG9zaXRpb24+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9zO1xuICAgIH1cblxuICAgIHNjcmVlbjJ3b3JsZCgpOiBSZWFkb25seTxBZmZpbmUyRD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zMnc7XG4gICAgfVxuXG4gICAgd29ybGQyc2NyZWVuKCk6IFJlYWRvbmx5PEFmZmluZTJEPiB7XG4gICAgICAgIHJldHVybiB0aGlzLncycztcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQYW5HZXN0dXJlIGltcGxlbWVudHMgR2VzdHVyZUhhbmRsZXIge1xuICAgIHByaXZhdGUgdnA6IFZpZXdwb3J0O1xuXG4gICAgY29uc3RydWN0b3IodnA6IFZpZXdwb3J0KSB7XG4gICAgICAgIHRoaXMudnAgPSB2cDtcbiAgICB9XG5cbiAgICB0YXAoX3Q6IFRhcCkgeyB9XG5cbiAgICBwYW4ocHM6IFBhbikge1xuICAgICAgICBpZiAocHMubGVuZ3RoICE9IDEpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwb3MgPSB0aGlzLnZwLnBvc2l0aW9uKCk7XG4gICAgICAgIGNvbnN0IHMydyA9IHRoaXMudnAuc2NyZWVuMndvcmxkKCk7XG4gICAgICAgIGNvbnN0IHAgPSBwc1twcy5sZW5ndGggLSAxXTtcbiAgICAgICAgY29uc3QgY3VyciA9IHRyYW5zZm9ybVBvaW50KHMydywgcC5jdXJyKTtcbiAgICAgICAgY29uc3QgcHJldiA9IHRyYW5zZm9ybVBvaW50KHMydywgcC5wcmV2KTtcbiAgICAgICAgdGhpcy52cC5zZXRQb3NpdGlvbih7XG4gICAgICAgICAgICBwb3M6IHBvaW50QWRkKHBvcy5wb3MsIHBvaW50U3ViKHByZXYsIGN1cnIpKSxcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgUGluY2hab29tR2VzdHVyZSBpbXBsZW1lbnRzIEdlc3R1cmVIYW5kbGVyIHtcbiAgICBwcml2YXRlIHZwOiBWaWV3cG9ydDtcblxuICAgIGNvbnN0cnVjdG9yKHZwOiBWaWV3cG9ydCkge1xuICAgICAgICB0aGlzLnZwID0gdnA7XG4gICAgfVxuXG4gICAgdGFwKF90OiBUYXApIHsgfVxuXG4gICAgcGFuKHBzOiBQYW4pIHtcbiAgICAgICAgaWYgKHBzLmxlbmd0aCA8IDIpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBwb3MgPSB0aGlzLnZwLnBvc2l0aW9uKCk7XG4gICAgICAgIGNvbnN0IHMydyA9IHRoaXMudnAuc2NyZWVuMndvcmxkKCk7XG4gICAgICAgIGNvbnN0IHAxID0gcHNbcHMubGVuZ3RoIC0gMV07XG4gICAgICAgIGNvbnN0IHAyID0gcHNbcHMubGVuZ3RoIC0gMl07XG5cbiAgICAgICAgY29uc3Qgd3AxcHJldiA9IHRyYW5zZm9ybVBvaW50KHMydywgcDEucHJldik7XG4gICAgICAgIGNvbnN0IGN1cnJhID0gcG9pbnRBbmdsZShwb2ludFN1YihwMi5jdXJyLCBwMS5jdXJyKSk7XG4gICAgICAgIGNvbnN0IHByZXZhID0gcG9pbnRBbmdsZShwb2ludFN1YihwMi5wcmV2LCBwMS5wcmV2KSk7XG4gICAgICAgIGNvbnN0IGN1cnJsID0gcG9pbnREaXN0YW5jZShwMS5jdXJyLCBwMi5jdXJyKTtcbiAgICAgICAgY29uc3QgcHJldmwgPSBwb2ludERpc3RhbmNlKHAxLnByZXYsIHAyLnByZXYpO1xuICAgICAgICBjb25zdCB3cDFjdXJyID0gdHJhbnNmb3JtUG9pbnQoczJ3LCBwMS5jdXJyKTtcbiAgICAgICAgbGV0IHQgPSB0cmFuc2Zvcm1UcmFuc2xhdGVDcmVhdGUoLXdwMWN1cnJbMF0sIC13cDFjdXJyWzFdKTtcbiAgICAgICAgdCA9IHRyYW5zZm9ybVNjYWxlKHQsIHByZXZsIC8gY3VycmwpO1xuICAgICAgICB0ID0gdHJhbnNmb3JtUm90YXRlKHQsIHByZXZhIC0gY3VycmEpO1xuICAgICAgICB0ID0gdHJhbnNmb3JtVHJhbnNsYXRlKHQsIHdwMXByZXZbMF0sIHdwMXByZXZbMV0pO1xuICAgICAgICAvLyBUT0RPOiB3aHkgZG9lcyB0aGlzIHdvcms/IElzbid0IGl0IGJhY2t3YXJkcz9cblxuICAgICAgICB0aGlzLnZwLnNldFBvc2l0aW9uKHtcbiAgICAgICAgICAgIHBvczogdHJhbnNmb3JtUG9pbnQodCwgcG9zLnBvcyksXG4gICAgICAgICAgICBzY2FsZTogcG9zLnNjYWxlICogY3VycmwgLyBwcmV2bCxcbiAgICAgICAgICAgIHJvdGF0ZTogcG9zLnJvdGF0ZSAtIHByZXZhICsgY3VycmEsXG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==