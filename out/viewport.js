import { transformTranslateCreate, transformRotate, transformStretch, transformInvert, transformPoint, transformTranslate } from './transform.js';
export const TOP_LEFT = 0;
export const TOP_RIGHT = 1;
export const BOTTOM_LEFT = 2;
export const BOTTOM_RIGHT = 3;
// Viewport keeps track of world <-> screen coordinates
// World coordinates are +x -> right, +y -> up
export class Viewport {
    constructor(ctx, render) {
        this.ctx = ctx;
        this.clearStyle = "white";
        this.render = render;
        this.resize = () => {
            const canvas = this.ctx.canvas;
            // TODO: support window.devicePixelRatio
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            this.setPosition(this.pos);
        };
        const canvas = this.ctx.canvas;
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        // Will be reset in setLocation below.
        this.pos = { pos: [0.0, 0.0], scale: 1.0, rotate: 0.0 };
        this.t = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.invt = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.bounds = [
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
        ];
        this.setPosition(this.pos);
    }
    setClearStyle(clearStyle) {
        this.clearStyle = clearStyle;
        this.redraw();
    }
    setPosition(pos) {
        if (pos.pos !== undefined) {
            this.pos.pos = pos.pos;
        }
        if (pos.rotate !== undefined) {
            this.pos.rotate = pos.rotate;
        }
        if (pos.scale !== undefined) {
            this.pos.scale = pos.scale;
        }
        const canvas = this.ctx.canvas;
        const width = canvas.width;
        const height = canvas.height;
        let t = transformTranslateCreate(-this.pos.pos[0], -this.pos.pos[1]);
        t = transformRotate(t, this.pos.rotate);
        t = transformStretch(t, this.pos.scale, -this.pos.scale);
        t = transformTranslate(t, width * 0.5, height * 0.5);
        this.t = t;
        const invt = transformInvert(t);
        this.bounds[0] = transformPoint(invt, [0, 0]);
        this.bounds[1] = transformPoint(invt, [width, 0]);
        this.bounds[2] = transformPoint(invt, [0, height]);
        this.bounds[3] = transformPoint(invt, [width, height]);
        this.invt = invt;
        this.redraw();
    }
    position() {
        return this.pos;
    }
    screen2world() {
        return this.invt;
    }
    world2screen() {
        return this.t;
    }
    redraw() {
        const ctx = this.ctx;
        if (this.clearStyle !== null) {
            const fillStyle = ctx.fillStyle;
            ctx.fillStyle = this.clearStyle;
            ctx.resetTransform();
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            ctx.fillStyle = fillStyle;
        }
        const t = this.t;
        ctx.setTransform(t[0], t[3], t[1], t[4], t[2], t[5]);
        this.render(this.bounds, this.pos.scale, ctx);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdmlld3BvcnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUFZLHdCQUF3QixFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFNUosTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUFHLENBQUMsQ0FBQztBQUMxQixNQUFNLENBQUMsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDO0FBQzNCLE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFDN0IsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLENBQUMsQ0FBQztBQWM5Qix1REFBdUQ7QUFDdkQsOENBQThDO0FBQzlDLE1BQU0sT0FBTyxRQUFRO0lBYWpCLFlBQVksR0FBNkIsRUFBRSxNQUFjO1FBQ3JELElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUM7UUFDMUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDZixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztZQUMvQix3Q0FBd0M7WUFDeEMsTUFBTSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDO1lBQ2xDLE1BQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUNwQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvQixDQUFDLENBQUE7UUFDRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztRQUMvQixNQUFNLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENB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Q0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyRCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDbEQsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdmlld3BvcnQuanNcbi8vXG4vLyBDb3B5cmlnaHQgQ2hhcmxlcyBEaWNrIDIwMjBcbmltcG9ydCB7IFBvaW50MkQgfSBmcm9tIFwiLi9wb2ludC5qc1wiXG5pbXBvcnQgeyBBZmZpbmUyRCwgdHJhbnNmb3JtVHJhbnNsYXRlQ3JlYXRlLCB0cmFuc2Zvcm1Sb3RhdGUsIHRyYW5zZm9ybVN0cmV0Y2gsIHRyYW5zZm9ybUludmVydCwgdHJhbnNmb3JtUG9pbnQsIHRyYW5zZm9ybVRyYW5zbGF0ZSB9IGZyb20gJy4vdHJhbnNmb3JtLmpzJztcblxuZXhwb3J0IGNvbnN0IFRPUF9MRUZUID0gMDtcbmV4cG9ydCBjb25zdCBUT1BfUklHSFQgPSAxO1xuZXhwb3J0IGNvbnN0IEJPVFRPTV9MRUZUID0gMjtcbmV4cG9ydCBjb25zdCBCT1RUT01fUklHSFQgPSAzO1xuXG5leHBvcnQgdHlwZSBCb3VuZHMgPSBbUG9pbnQyRCwgUG9pbnQyRCwgUG9pbnQyRCwgUG9pbnQyRF07XG5cbmV4cG9ydCB0eXBlIFZpZXdwb3J0UG9zaXRpb24gPSB7XG4gICAgcG9zOiBQb2ludDJEO1xuICAgIHNjYWxlOiBudW1iZXI7XG4gICAgcm90YXRlOiBudW1iZXI7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlbmRlciB7XG4gICAgKGI6IEJvdW5kcywgczogbnVtYmVyLCBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCk6IHZvaWQ7XG59XG5cbi8vIFZpZXdwb3J0IGtlZXBzIHRyYWNrIG9mIHdvcmxkIDwtPiBzY3JlZW4gY29vcmRpbmF0ZXNcbi8vIFdvcmxkIGNvb3JkaW5hdGVzIGFyZSAreCAtPiByaWdodCwgK3kgLT4gdXBcbmV4cG9ydCBjbGFzcyBWaWV3cG9ydCB7XG4gICAgcmVhZG9ubHkgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XG4gICAgcHJpdmF0ZSBwb3M6IFZpZXdwb3J0UG9zaXRpb247XG4gICAgLy8gVE9ETzogdCBuZWVkcyB0byBiZSB0d28gdGhpbmdzOiB3b3JsZDJzY3JlZW4sIGFuZCB3b3JsZDJjYW52YXMgKHNpbmNlIGNhbnZhcyBjYW4gYmUgZGlmZmVyZW50IGZyb20gc2NyZWVuIGR1ZSB0byBkZXZpY2VQaXhlbFJhdGlvKVxuICAgIHByaXZhdGUgdDogQWZmaW5lMkQ7XG4gICAgcHJpdmF0ZSBpbnZ0OiBBZmZpbmUyRDtcbiAgICBwcml2YXRlIGNsZWFyU3R5bGU6IG51bGwgfCBzdHJpbmcgfCBDYW52YXNHcmFkaWVudCB8IENhbnZhc1BhdHRlcm47XG4gICAgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcjtcbiAgICBwcml2YXRlIGJvdW5kczogQm91bmRzO1xuXG4gICAgLy8gTmVlZHMgdG8gYmUgaG9va2VkIHVwIHRvIERPTSByZXNpemUgbGlzdGVuZXJcbiAgICByZXNpemU6ICgpID0+IHZvaWQ7XG5cbiAgICBjb25zdHJ1Y3RvcihjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgcmVuZGVyOiBSZW5kZXIpIHtcbiAgICAgICAgdGhpcy5jdHggPSBjdHg7XG4gICAgICAgIHRoaXMuY2xlYXJTdHlsZSA9IFwid2hpdGVcIjtcbiAgICAgICAgdGhpcy5yZW5kZXIgPSByZW5kZXI7XG4gICAgICAgIHRoaXMucmVzaXplID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICAgICAgLy8gVE9ETzogc3VwcG9ydCB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpb1xuICAgICAgICAgICAgY2FudmFzLndpZHRoID0gY2FudmFzLm9mZnNldFdpZHRoO1xuICAgICAgICAgICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5vZmZzZXRIZWlnaHQ7XG4gICAgICAgICAgICB0aGlzLnNldFBvc2l0aW9uKHRoaXMucG9zKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBjYW52YXMgPSB0aGlzLmN0eC5jYW52YXM7XG4gICAgICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy5vZmZzZXRXaWR0aDtcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5vZmZzZXRIZWlnaHQ7XG5cbiAgICAgICAgLy8gV2lsbCBiZSByZXNldCBpbiBzZXRMb2NhdGlvbiBiZWxvdy5cbiAgICAgICAgdGhpcy5wb3MgPSB7IHBvczogWzAuMCwgMC4wXSwgc2NhbGU6IDEuMCwgcm90YXRlOiAwLjAgfTtcbiAgICAgICAgdGhpcy50ID0gWzAuMCwgMC4wLCAwLjAsIDAuMCwgMC4wLCAwLjBdO1xuICAgICAgICB0aGlzLmludnQgPSBbMC4wLCAwLjAsIDAuMCwgMC4wLCAwLjAsIDAuMF07XG4gICAgICAgIHRoaXMuYm91bmRzID0gW1xuICAgICAgICAgICAgWzAuMCwgMC4wXSxcbiAgICAgICAgICAgIFswLjAsIDAuMF0sXG4gICAgICAgICAgICBbMC4wLCAwLjBdLFxuICAgICAgICAgICAgWzAuMCwgMC4wXSxcbiAgICAgICAgXTtcbiAgICAgICAgdGhpcy5zZXRQb3NpdGlvbih0aGlzLnBvcyk7XG4gICAgfVxuXG4gICAgc2V0Q2xlYXJTdHlsZShjbGVhclN0eWxlOiBudWxsIHwgc3RyaW5nIHwgQ2FudmFzR3JhZGllbnQgfCBDYW52YXNQYXR0ZXJuKSB7XG4gICAgICAgIHRoaXMuY2xlYXJTdHlsZSA9IGNsZWFyU3R5bGU7XG4gICAgICAgIHRoaXMucmVkcmF3KCk7XG4gICAgfVxuXG4gICAgc2V0UG9zaXRpb24ocG9zOiBQYXJ0aWFsPFZpZXdwb3J0UG9zaXRpb24+KSB7XG4gICAgICAgIGlmIChwb3MucG9zICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMucG9zLnBvcyA9IHBvcy5wb3M7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHBvcy5yb3RhdGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5wb3Mucm90YXRlID0gcG9zLnJvdGF0ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAocG9zLnNjYWxlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMucG9zLnNjYWxlID0gcG9zLnNjYWxlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuY3R4LmNhbnZhcztcbiAgICAgICAgY29uc3Qgd2lkdGggPSBjYW52YXMud2lkdGg7XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IGNhbnZhcy5oZWlnaHQ7XG4gICAgICAgIGxldCB0ID0gdHJhbnNmb3JtVHJhbnNsYXRlQ3JlYXRlKC10aGlzLnBvcy5wb3NbMF0sIC10aGlzLnBvcy5wb3NbMV0pO1xuICAgICAgICB0ID0gdHJhbnNmb3JtUm90YXRlKHQsIHRoaXMucG9zLnJvdGF0ZSk7XG4gICAgICAgIHQgPSB0cmFuc2Zvcm1TdHJldGNoKHQsIHRoaXMucG9zLnNjYWxlLCAtdGhpcy5wb3Muc2NhbGUpO1xuICAgICAgICB0ID0gdHJhbnNmb3JtVHJhbnNsYXRlKHQsIHdpZHRoICogMC41LCBoZWlnaHQgKiAwLjUpO1xuICAgICAgICB0aGlzLnQgPSB0O1xuXG4gICAgICAgIGNvbnN0IGludnQgPSB0cmFuc2Zvcm1JbnZlcnQodCk7XG4gICAgICAgIHRoaXMuYm91bmRzWzBdID0gdHJhbnNmb3JtUG9pbnQoaW52dCwgWzAsIDBdKTtcbiAgICAgICAgdGhpcy5ib3VuZHNbMV0gPSB0cmFuc2Zvcm1Qb2ludChpbnZ0LCBbd2lkdGgsIDBdKTtcbiAgICAgICAgdGhpcy5ib3VuZHNbMl0gPSB0cmFuc2Zvcm1Qb2ludChpbnZ0LCBbMCwgaGVpZ2h0XSk7XG4gICAgICAgIHRoaXMuYm91bmRzWzNdID0gdHJhbnNmb3JtUG9pbnQoaW52dCwgW3dpZHRoLCBoZWlnaHRdKTtcbiAgICAgICAgdGhpcy5pbnZ0ID0gaW52dDtcbiAgICAgICAgdGhpcy5yZWRyYXcoKTtcbiAgICB9XG5cbiAgICBwb3NpdGlvbigpOiBSZWFkb25seTxWaWV3cG9ydFBvc2l0aW9uPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnBvcztcbiAgICB9XG5cbiAgICBzY3JlZW4yd29ybGQoKTogUmVhZG9ubHk8QWZmaW5lMkQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaW52dDtcbiAgICB9XG5cbiAgICB3b3JsZDJzY3JlZW4oKTogUmVhZG9ubHk8QWZmaW5lMkQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMudDtcbiAgICB9XG5cbiAgICByZWRyYXcoKSB7XG4gICAgICAgIGNvbnN0IGN0eCA9IHRoaXMuY3R4O1xuICAgICAgICBpZiAodGhpcy5jbGVhclN0eWxlICE9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zdCBmaWxsU3R5bGUgPSBjdHguZmlsbFN0eWxlO1xuICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHRoaXMuY2xlYXJTdHlsZTtcbiAgICAgICAgICAgIGN0eC5yZXNldFRyYW5zZm9ybSgpO1xuICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGN0eC5jYW52YXMud2lkdGgsIGN0eC5jYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSBmaWxsU3R5bGU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdCA9IHRoaXMudDtcbiAgICAgICAgY3R4LnNldFRyYW5zZm9ybSh0WzBdLCB0WzNdLCB0WzFdLCB0WzRdLCB0WzJdLCB0WzVdKTtcbiAgICAgICAgdGhpcy5yZW5kZXIodGhpcy5ib3VuZHMsIHRoaXMucG9zLnNjYWxlLCBjdHgpO1xuICAgIH1cblxufVxuIl19