import { transformTranslateCreate, transformRotate, transformStretch, transformInvert, transformPoint, transformTranslate, transformScale } from './transform.js';
export const TOP_LEFT = 0;
export const TOP_RIGHT = 1;
export const BOTTOM_LEFT = 2;
export const BOTTOM_RIGHT = 3;
// Viewport keeps track of world <-> screen coordinates
// World coordinates are +x -> right, +y -> up
export class Viewport {
    constructor(ctx, render) {
        this.ctx = ctx;
        this.clearStyle = "white";
        this.render = render;
        this.recentRedraw = false;
        this.redrawRequested = false;
        this.redraw = () => {
            this.recentRedraw = true;
            requestAnimationFrame(this.clearRecentRedraw);
            const ctx = this.ctx;
            if (this.clearStyle !== null) {
                const fillStyle = ctx.fillStyle;
                ctx.fillStyle = this.clearStyle;
                ctx.resetTransform();
                ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = fillStyle;
            }
            const t = this.w2c;
            ctx.setTransform(t[0], t[3], t[1], t[4], t[2], t[5]);
            this.render(this.bounds, this.pos.scale, ctx);
        };
        this.clearRecentRedraw = () => {
            const requested = this.redrawRequested;
            this.recentRedraw = false;
            this.redrawRequested = false;
            if (requested) {
                this.redraw();
            }
        };
        this.resize = () => {
            const canvas = this.ctx.canvas;
            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            this.setPosition(this.pos);
        };
        const canvas = this.ctx.canvas;
        canvas.width = canvas.offsetWidth * window.devicePixelRatio;
        canvas.height = canvas.offsetHeight * window.devicePixelRatio;
        // Will be reset in setLocation below.
        this.pos = { pos: [0.0, 0.0], scale: 1.0, rotate: 0.0 };
        this.s2w = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.w2c = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.w2s = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.bounds = [
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
        ];
        this.setPosition(this.pos);
    }
    requestRedraw() {
        if (this.recentRedraw) {
            this.redrawRequested = true;
        }
        else {
            this.redraw();
        }
    }
    setClearStyle(clearStyle) {
        this.clearStyle = clearStyle;
        this.requestRedraw();
    }
    setPosition(pos) {
        if (pos.pos !== undefined) {
            this.pos.pos = pos.pos;
        }
        if (pos.rotate !== undefined) {
            this.pos.rotate = pos.rotate;
        }
        if (pos.scale !== undefined) {
            this.pos.scale = pos.scale;
        }
        const canvas = this.ctx.canvas;
        const dpr = window.devicePixelRatio;
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;
        let w2 = transformTranslateCreate(-this.pos.pos[0], -this.pos.pos[1]);
        w2 = transformRotate(w2, this.pos.rotate);
        w2 = transformStretch(w2, this.pos.scale, -this.pos.scale);
        w2 = transformTranslate(w2, width * 0.5, height * 0.5);
        this.w2s = w2;
        w2 = transformScale(w2, dpr);
        this.w2c = w2;
        const s2w = transformInvert(this.w2s);
        this.bounds[0] = transformPoint(s2w, [0, 0]);
        this.bounds[1] = transformPoint(s2w, [width, 0]);
        this.bounds[2] = transformPoint(s2w, [0, height]);
        this.bounds[3] = transformPoint(s2w, [width, height]);
        this.s2w = s2w;
        this.requestRedraw();
    }
    position() {
        return this.pos;
    }
    screen2world() {
        return this.s2w;
    }
    world2screen() {
        return this.w2s;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdmlld3BvcnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUEsT0FBTyxFQUFZLHdCQUF3QixFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTVLLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBRyxDQUFDLENBQUM7QUFDMUIsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQztBQUMzQixNQUFNLENBQUMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQzdCLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxDQUFDLENBQUM7QUFjOUIsdURBQXVEO0FBQ3ZELDhDQUE4QztBQUM5QyxNQUFNLE9BQU8sUUFBUTtJQXdCakIsWUFBWSxHQUE2QixFQUFFLE1BQWM7UUFDckQsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQztRQUMxQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsWUFBWSxHQUFHLEtBQUssQ0FBQztRQUMxQixJQUFJLENBQUMsZUFBZSxHQUFHLEtBQUssQ0FBQztRQUM3QixJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRTtZQUNmLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1lBQ3pCLHFCQUFxQixDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1lBQzlDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDckIsSUFBSSxJQUFJLENBQUMsVUFBVSxLQUFLLElBQUksRUFBRTtnQkFDMUIsTUFBTSxTQUFTLEdBQUcsR0FBRyxDQUFDLFNBQVMsQ0FBQztnQkFDaEMsR0FBRyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO2dCQUNoQyxHQUFHLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3JCLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUN4RCxHQUFHLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQzthQUM3QjtZQUNELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDbkIsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUE7UUFDRCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsR0FBRyxFQUFFO1lBQzFCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUM7WUFDdkMsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7WUFDMUIsSUFBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7WUFDN0IsSUFBSSxTQUFTLEVBQUU7Z0JBQ1gsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO2FBQ2pCO1FBQ0wsQ0FBQyxDQUFBO1FBQ0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDZixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztZQUMvQixNQUFNLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1lBQzVELE1BQU0sQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUM7WUFDOUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFBO1FBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7UUFDL0IsTUFBTSxDQUFDLEtBQUssR0FBRyxNQUFNLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztRQUM1RCxNQUFNLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1FBRTlELHNDQUFzQztRQUN0QyxJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ3hELElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxNQUFNLEdBQUc7WUFDVixDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7WUFDVixDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7WUFDVixDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7WUFDVixDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7U0FDYixDQUFDO1FBQ0YsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQTNETyxhQUFhO1FBQ2pCLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRTtZQUNuQixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztTQUMvQjthQUFNO1lBQ0gsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1NBQ2pCO0lBQ0wsQ0FBQztJQXVERCxhQUFhLENBQUMsVUFBMEQ7UUFDcEUsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7UUFDN0IsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFFRCxXQUFXLENBQUMsR0FBOEI7UUFDdEMsSUFBSSxHQUFHLENBQUMsR0FBRyxLQUFLLFNBQVMsRUFBRTtZQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDO1NBQzFCO1FBQ0QsSUFBSSxHQUFHLENBQUMsTUFBTSxLQUFLLFNBQVMsRUFBRTtZQUMxQixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDO1NBQ2hDO1FBQ0QsSUFBSSxHQUFHLENBQUMsS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUN6QixJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDO1NBQzlCO1FBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7UUFDL0IsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1FBQ3BDLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxXQUFXLENBQUM7UUFDakMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQztRQUNuQyxJQUFJLEVBQUUsR0FBRyx3QkFBd0IsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN0RSxFQUFFLEdBQUcsZUFBZSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzFDLEVBQUUsR0FBRyxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzNELEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsS0FBSyxHQUFHLEdBQUcsRUFBRSxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDdkQsSUFBSSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUM7UUFDZCxFQUFFLEdBQUcsY0FBYyxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQztRQUVkLE1BQU0sR0FBRyxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxjQUFjLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxjQUFjLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxjQUFjLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxjQUFjLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDdEQsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7UUFDZixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVELFFBQVE7UUFDSixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDcEIsQ0FBQztJQUVELFlBQVk7UUFDUixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDcEIsQ0FBQztJQUVELFlBQVk7UUFDUixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUM7SUFDcEIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiLy8gdmlld3BvcnQuanNcbi8vXG4vLyBDb3B5cmlnaHQgQ2hhcmxlcyBEaWNrIDIwMjBcbmltcG9ydCB7IFBvaW50MkQgfSBmcm9tIFwiLi9wb2ludC5qc1wiXG5pbXBvcnQgeyBBZmZpbmUyRCwgdHJhbnNmb3JtVHJhbnNsYXRlQ3JlYXRlLCB0cmFuc2Zvcm1Sb3RhdGUsIHRyYW5zZm9ybVN0cmV0Y2gsIHRyYW5zZm9ybUludmVydCwgdHJhbnNmb3JtUG9pbnQsIHRyYW5zZm9ybVRyYW5zbGF0ZSwgdHJhbnNmb3JtU2NhbGUgfSBmcm9tICcuL3RyYW5zZm9ybS5qcyc7XG5cbmV4cG9ydCBjb25zdCBUT1BfTEVGVCA9IDA7XG5leHBvcnQgY29uc3QgVE9QX1JJR0hUID0gMTtcbmV4cG9ydCBjb25zdCBCT1RUT01fTEVGVCA9IDI7XG5leHBvcnQgY29uc3QgQk9UVE9NX1JJR0hUID0gMztcblxuZXhwb3J0IHR5cGUgQm91bmRzID0gW1BvaW50MkQsIFBvaW50MkQsIFBvaW50MkQsIFBvaW50MkRdO1xuXG5leHBvcnQgdHlwZSBWaWV3cG9ydFBvc2l0aW9uID0ge1xuICAgIHBvczogUG9pbnQyRDtcbiAgICBzY2FsZTogbnVtYmVyO1xuICAgIHJvdGF0ZTogbnVtYmVyO1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBSZW5kZXIge1xuICAgIChiOiBCb3VuZHMsIHM6IG51bWJlciwgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQpOiB2b2lkO1xufVxuXG4vLyBWaWV3cG9ydCBrZWVwcyB0cmFjayBvZiB3b3JsZCA8LT4gc2NyZWVuIGNvb3JkaW5hdGVzXG4vLyBXb3JsZCBjb29yZGluYXRlcyBhcmUgK3ggLT4gcmlnaHQsICt5IC0+IHVwXG5leHBvcnQgY2xhc3MgVmlld3BvcnQge1xuICAgIHJlYWRvbmx5IGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEO1xuICAgIHByaXZhdGUgcG9zOiBWaWV3cG9ydFBvc2l0aW9uO1xuICAgIHByaXZhdGUgdzJjOiBBZmZpbmUyRDsgIC8vIFdvcmxkIHRvIGNhbnZhcyB0cmFuc2Zvcm1cbiAgICBwcml2YXRlIHcyczogQWZmaW5lMkQ7ICAvLyBXb3JsZCB0byBzY3JlZW4gdHJhbnNmb3JtLCBkaWZmZXJlbnQgZnJvbSB3MmMgaWYgd2luZG93LmRldmljZVBpeGVsUmF0aW8gIT0gMVxuICAgIHByaXZhdGUgczJ3OiBBZmZpbmUyRDsgIC8vIFNjcmVlbiB0byB3b3JsZCB0cmFuc2Zvcm1cbiAgICBwcml2YXRlIGNsZWFyU3R5bGU6IG51bGwgfCBzdHJpbmcgfCBDYW52YXNHcmFkaWVudCB8IENhbnZhc1BhdHRlcm47XG4gICAgcHJpdmF0ZSByZW5kZXI6IFJlbmRlcjtcbiAgICBwcml2YXRlIGJvdW5kczogQm91bmRzO1xuICAgIC8vIE5lZWRzIHRvIGJlIGhvb2tlZCB1cCB0byBET00gcmVzaXplIGxpc3RlbmVyXG4gICAgcmVzaXplOiAoKSA9PiB2b2lkO1xuICAgIHByaXZhdGUgcmVkcmF3OiAoKSA9PiB2b2lkO1xuICAgIHByaXZhdGUgY2xlYXJSZWNlbnRSZWRyYXc6ICgpID0+IHZvaWQ7XG4gICAgcHJpdmF0ZSByZWNlbnRSZWRyYXc6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSByZWRyYXdSZXF1ZXN0ZWQ6IGJvb2xlYW47XG5cbiAgICBwcml2YXRlIHJlcXVlc3RSZWRyYXcoKSB7XG4gICAgICAgIGlmICh0aGlzLnJlY2VudFJlZHJhdykge1xuICAgICAgICAgICAgdGhpcy5yZWRyYXdSZXF1ZXN0ZWQgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZWRyYXcoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCByZW5kZXI6IFJlbmRlcikge1xuICAgICAgICB0aGlzLmN0eCA9IGN0eDtcbiAgICAgICAgdGhpcy5jbGVhclN0eWxlID0gXCJ3aGl0ZVwiO1xuICAgICAgICB0aGlzLnJlbmRlciA9IHJlbmRlcjtcbiAgICAgICAgdGhpcy5yZWNlbnRSZWRyYXcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZWRyYXdSZXF1ZXN0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZWRyYXcgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlY2VudFJlZHJhdyA9IHRydWU7XG4gICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5jbGVhclJlY2VudFJlZHJhdyk7XG4gICAgICAgICAgICBjb25zdCBjdHggPSB0aGlzLmN0eDtcbiAgICAgICAgICAgIGlmICh0aGlzLmNsZWFyU3R5bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxsU3R5bGUgPSBjdHguZmlsbFN0eWxlO1xuICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmNsZWFyU3R5bGU7XG4gICAgICAgICAgICAgICAgY3R4LnJlc2V0VHJhbnNmb3JtKCk7XG4gICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGN0eC5jYW52YXMud2lkdGgsIGN0eC5jYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZmlsbFN0eWxlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMudzJjO1xuICAgICAgICAgICAgY3R4LnNldFRyYW5zZm9ybSh0WzBdLCB0WzNdLCB0WzFdLCB0WzRdLCB0WzJdLCB0WzVdKTtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyKHRoaXMuYm91bmRzLCB0aGlzLnBvcy5zY2FsZSwgY3R4KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNsZWFyUmVjZW50UmVkcmF3ID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdGVkID0gdGhpcy5yZWRyYXdSZXF1ZXN0ZWQ7XG4gICAgICAgICAgICB0aGlzLnJlY2VudFJlZHJhdyA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5yZWRyYXdSZXF1ZXN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChyZXF1ZXN0ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZHJhdygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVzaXplID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICAgICAgY2FudmFzLndpZHRoID0gY2FudmFzLm9mZnNldFdpZHRoICogd2luZG93LmRldmljZVBpeGVsUmF0aW87XG4gICAgICAgICAgICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzLm9mZnNldEhlaWdodCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xuICAgICAgICAgICAgdGhpcy5zZXRQb3NpdGlvbih0aGlzLnBvcyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICBjYW52YXMud2lkdGggPSBjYW52YXMub2Zmc2V0V2lkdGggKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbztcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5vZmZzZXRIZWlnaHQgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbztcblxuICAgICAgICAvLyBXaWxsIGJlIHJlc2V0IGluIHNldExvY2F0aW9uIGJlbG93LlxuICAgICAgICB0aGlzLnBvcyA9IHsgcG9zOiBbMC4wLCAwLjBdLCBzY2FsZTogMS4wLCByb3RhdGU6IDAuMCB9O1xuICAgICAgICB0aGlzLnMydyA9IFswLjAsIDAuMCwgMC4wLCAwLjAsIDAuMCwgMC4wXTtcbiAgICAgICAgdGhpcy53MmMgPSBbMC4wLCAwLjAsIDAuMCwgMC4wLCAwLjAsIDAuMF07XG4gICAgICAgIHRoaXMudzJzID0gWzAuMCwgMC4wLCAwLjAsIDAuMCwgMC4wLCAwLjBdO1xuICAgICAgICB0aGlzLmJvdW5kcyA9IFtcbiAgICAgICAgICAgIFswLjAsIDAuMF0sXG4gICAgICAgICAgICBbMC4wLCAwLjBdLFxuICAgICAgICAgICAgWzAuMCwgMC4wXSxcbiAgICAgICAgICAgIFswLjAsIDAuMF0sXG4gICAgICAgIF07XG4gICAgICAgIHRoaXMuc2V0UG9zaXRpb24odGhpcy5wb3MpO1xuICAgIH1cblxuICAgIHNldENsZWFyU3R5bGUoY2xlYXJTdHlsZTogbnVsbCB8IHN0cmluZyB8IENhbnZhc0dyYWRpZW50IHwgQ2FudmFzUGF0dGVybikge1xuICAgICAgICB0aGlzLmNsZWFyU3R5bGUgPSBjbGVhclN0eWxlO1xuICAgICAgICB0aGlzLnJlcXVlc3RSZWRyYXcoKTtcbiAgICB9XG5cbiAgICBzZXRQb3NpdGlvbihwb3M6IFBhcnRpYWw8Vmlld3BvcnRQb3NpdGlvbj4pIHtcbiAgICAgICAgaWYgKHBvcy5wb3MgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5wb3MucG9zID0gcG9zLnBvcztcbiAgICAgICAgfVxuICAgICAgICBpZiAocG9zLnJvdGF0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLnBvcy5yb3RhdGUgPSBwb3Mucm90YXRlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwb3Muc2NhbGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5wb3Muc2NhbGUgPSBwb3Muc2NhbGU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICBjb25zdCBkcHIgPSB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbztcbiAgICAgICAgY29uc3Qgd2lkdGggPSBjYW52YXMub2Zmc2V0V2lkdGg7XG4gICAgICAgIGNvbnN0IGhlaWdodCA9IGNhbnZhcy5vZmZzZXRIZWlnaHQ7XG4gICAgICAgIGxldCB3MiA9IHRyYW5zZm9ybVRyYW5zbGF0ZUNyZWF0ZSgtdGhpcy5wb3MucG9zWzBdLCAtdGhpcy5wb3MucG9zWzFdKTtcbiAgICAgICAgdzIgPSB0cmFuc2Zvcm1Sb3RhdGUodzIsIHRoaXMucG9zLnJvdGF0ZSk7XG4gICAgICAgIHcyID0gdHJhbnNmb3JtU3RyZXRjaCh3MiwgdGhpcy5wb3Muc2NhbGUsIC10aGlzLnBvcy5zY2FsZSk7XG4gICAgICAgIHcyID0gdHJhbnNmb3JtVHJhbnNsYXRlKHcyLCB3aWR0aCAqIDAuNSwgaGVpZ2h0ICogMC41KTtcbiAgICAgICAgdGhpcy53MnMgPSB3MjtcbiAgICAgICAgdzIgPSB0cmFuc2Zvcm1TY2FsZSh3MiwgZHByKTtcbiAgICAgICAgdGhpcy53MmMgPSB3MjtcblxuICAgICAgICBjb25zdCBzMncgPSB0cmFuc2Zvcm1JbnZlcnQodGhpcy53MnMpO1xuICAgICAgICB0aGlzLmJvdW5kc1swXSA9IHRyYW5zZm9ybVBvaW50KHMydywgWzAsIDBdKTtcbiAgICAgICAgdGhpcy5ib3VuZHNbMV0gPSB0cmFuc2Zvcm1Qb2ludChzMncsIFt3aWR0aCwgMF0pO1xuICAgICAgICB0aGlzLmJvdW5kc1syXSA9IHRyYW5zZm9ybVBvaW50KHMydywgWzAsIGhlaWdodF0pO1xuICAgICAgICB0aGlzLmJvdW5kc1szXSA9IHRyYW5zZm9ybVBvaW50KHMydywgW3dpZHRoLCBoZWlnaHRdKTtcbiAgICAgICAgdGhpcy5zMncgPSBzMnc7XG4gICAgICAgIHRoaXMucmVxdWVzdFJlZHJhdygpO1xuICAgIH1cblxuICAgIHBvc2l0aW9uKCk6IFJlYWRvbmx5PFZpZXdwb3J0UG9zaXRpb24+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9zO1xuICAgIH1cblxuICAgIHNjcmVlbjJ3b3JsZCgpOiBSZWFkb25seTxBZmZpbmUyRD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zMnc7XG4gICAgfVxuXG4gICAgd29ybGQyc2NyZWVuKCk6IFJlYWRvbmx5PEFmZmluZTJEPiB7XG4gICAgICAgIHJldHVybiB0aGlzLncycztcbiAgICB9XG59XG4iXX0=