// Copyright Charles Dueck 2020
import { pointAdd, pointSub, pointAngle, pointDistance } from "./point.js";
import { transformTranslateCreate, transformRotate, transformStretch, transformInvert, transformPoint, transformTranslate, transformScale } from './transform.js';
export const TOP_LEFT = 0;
export const TOP_RIGHT = 1;
export const BOTTOM_LEFT = 2;
export const BOTTOM_RIGHT = 3;
// Viewport keeps track of world <-> screen coordinates
// World coordinates are +x -> right, +y -> up
export class Viewport {
    constructor(ctx, render) {
        this.ctx = ctx;
        this.clearStyle = "white";
        this.posClipper = null;
        this.render = render;
        this.recentRedraw = false;
        this.redrawRequested = false;
        this.redraw = () => {
            this.recentRedraw = true;
            requestAnimationFrame(this.clearRecentRedraw);
            const ctx = this.ctx;
            if (this.clearStyle !== null) {
                const fillStyle = ctx.fillStyle;
                ctx.fillStyle = this.clearStyle;
                ctx.resetTransform();
                ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.fillStyle = fillStyle;
            }
            const t = this.w2c;
            ctx.setTransform(t[0], t[3], t[1], t[4], t[2], t[5]);
            this.render(this.bounds, this.pos.scale, ctx);
        };
        this.clearRecentRedraw = () => {
            const requested = this.redrawRequested;
            this.recentRedraw = false;
            this.redrawRequested = false;
            if (requested) {
                this.redraw();
            }
        };
        this.resize = () => {
            const canvas = this.ctx.canvas;
            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            this.setPosition(this.pos);
        };
        const canvas = this.ctx.canvas;
        canvas.width = canvas.offsetWidth * window.devicePixelRatio;
        canvas.height = canvas.offsetHeight * window.devicePixelRatio;
        // Will be reset in setLocation below.
        this.pos = { pos: [0.0, 0.0], scale: 1.0, rotate: 0.0 };
        this.s2w = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.w2c = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.w2s = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        this.bounds = [
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
            [0.0, 0.0],
        ];
        this.setPosition(this.pos);
    }
    requestRedraw() {
        if (this.recentRedraw) {
            this.redrawRequested = true;
        }
        else {
            this.redraw();
        }
    }
    setClearStyle(clearStyle) {
        this.clearStyle = clearStyle;
        this.requestRedraw();
    }
    setClipPosition(clip) {
        this.posClipper = clip;
        this.setPosition(this.pos);
    }
    setPosition(pos) {
        if (pos.pos !== undefined) {
            this.pos.pos = pos.pos;
        }
        if (pos.rotate !== undefined) {
            if (pos.rotate >= Math.PI) {
                this.pos.rotate = pos.rotate - Math.floor(pos.rotate / (2.0 * Math.PI)) * 2.0 * Math.PI;
            }
            else if (pos.rotate < -Math.PI) {
                this.pos.rotate = pos.rotate - Math.ceil(pos.rotate / (2.0 * Math.PI)) * 2.0 * Math.PI;
            }
            else {
                this.pos.rotate = pos.rotate;
            }
        }
        if (pos.scale !== undefined) {
            this.pos.scale = pos.scale;
        }
        if (this.posClipper !== null) {
            this.pos = this.posClipper(this.pos);
        }
        const canvas = this.ctx.canvas;
        const dpr = window.devicePixelRatio;
        const width = canvas.offsetWidth;
        const height = canvas.offsetHeight;
        let w2 = transformTranslateCreate(-this.pos.pos[0], -this.pos.pos[1]);
        w2 = transformRotate(w2, this.pos.rotate);
        w2 = transformStretch(w2, this.pos.scale, -this.pos.scale);
        w2 = transformTranslate(w2, width * 0.5, height * 0.5);
        this.w2s = w2;
        w2 = transformScale(w2, dpr);
        this.w2c = w2;
        const s2w = transformInvert(this.w2s);
        this.bounds[0] = transformPoint(s2w, [0, 0]);
        this.bounds[1] = transformPoint(s2w, [width, 0]);
        this.bounds[2] = transformPoint(s2w, [0, height]);
        this.bounds[3] = transformPoint(s2w, [width, height]);
        this.s2w = s2w;
        this.requestRedraw();
    }
    position() {
        return this.pos;
    }
    screen2world() {
        return this.s2w;
    }
    world2screen() {
        return this.w2s;
    }
}
export class PanGesture {
    constructor(vp) {
        this.vp = vp;
    }
    tap(_t) { }
    pan(ps) {
        if (ps.length != 1) {
            return;
        }
        const pos = this.vp.position();
        const s2w = this.vp.screen2world();
        const p = ps[ps.length - 1];
        const curr = transformPoint(s2w, p.curr);
        const prev = transformPoint(s2w, p.prev);
        this.vp.setPosition({
            pos: pointAdd(pos.pos, pointSub(prev, curr)),
        });
    }
}
export class PinchZoomGesture {
    constructor(vp) {
        this.vp = vp;
    }
    tap(_t) { }
    pan(ps) {
        if (ps.length < 2) {
            return;
        }
        const pos = this.vp.position();
        const s2w = this.vp.screen2world();
        const p1 = ps[ps.length - 1];
        const p2 = ps[ps.length - 2];
        const wp1prev = transformPoint(s2w, p1.prev);
        const curra = pointAngle(pointSub(p2.curr, p1.curr));
        const preva = pointAngle(pointSub(p2.prev, p1.prev));
        const currl = pointDistance(p1.curr, p2.curr);
        const prevl = pointDistance(p1.prev, p2.prev);
        const wp1curr = transformPoint(s2w, p1.curr);
        let t = transformTranslateCreate(-wp1curr[0], -wp1curr[1]);
        t = transformScale(t, prevl / currl);
        t = transformRotate(t, preva - curra);
        t = transformTranslate(t, wp1prev[0], wp1prev[1]);
        // TODO: why does this work? Isn't it backwards?
        this.vp.setPosition({
            pos: transformPoint(t, pos.pos),
            scale: pos.scale * currl / prevl,
            rotate: pos.rotate - preva + curra,
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld3BvcnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdmlld3BvcnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsK0JBQStCO0FBRS9CLE9BQU8sRUFBVyxRQUFRLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxhQUFhLEVBQUUsTUFBTSxZQUFZLENBQUE7QUFDbkYsT0FBTyxFQUFZLHdCQUF3QixFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzVLLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FBRyxDQUFDLENBQUM7QUFDMUIsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLENBQUMsQ0FBQztBQUMzQixNQUFNLENBQUMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQzdCLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBRyxDQUFDLENBQUM7QUFrQjlCLHVEQUF1RDtBQUN2RCw4Q0FBOEM7QUFDOUMsTUFBTSxPQUFPLFFBQVE7SUE0QmpCLFlBQVksR0FBNkIsRUFBRSxNQUFjO1FBQ3JELElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUM7UUFDMUIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDdkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7UUFDMUIsSUFBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7UUFDN0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFDZixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQztZQUN6QixxQkFBcUIsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQztZQUM5QyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMs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Q0FBQyxFQUFFLEtBQUssR0FBRyxLQUFLLENBQUMsQ0FBQztRQUNyQyxDQUFDLEdBQUcsZUFBZSxDQUFDLENBQUMsRUFBRSxLQUFLLEdBQUcsS0FBSyxDQUFDLENBQUM7UUFDdEMsQ0FBQyxHQUFHLGtCQUFrQixDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDbEQsZ0RBQWdEO1FBRWhELElBQUksQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDO1lBQ2hCLEdBQUcsRUFBRSxjQUFjLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUM7WUFDL0IsS0FBSyxFQUFFLEdBQUcsQ0FBQyxLQUFLLEdBQUcsS0FBSyxHQUFHLEtBQUs7WUFDaEMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNLEdBQUcsS0FBSyxHQUFHLEtBQUs7U0FDckMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IENoYXJsZXMgRHVlY2sgMjAyMFxuXG5pbXBvcnQgeyBQb2ludDJELCBwb2ludEFkZCwgcG9pbnRTdWIsIHBvaW50QW5nbGUsIHBvaW50RGlzdGFuY2UgfSBmcm9tIFwiLi9wb2ludC5qc1wiXG5pbXBvcnQgeyBBZmZpbmUyRCwgdHJhbnNmb3JtVHJhbnNsYXRlQ3JlYXRlLCB0cmFuc2Zvcm1Sb3RhdGUsIHRyYW5zZm9ybVN0cmV0Y2gsIHRyYW5zZm9ybUludmVydCwgdHJhbnNmb3JtUG9pbnQsIHRyYW5zZm9ybVRyYW5zbGF0ZSwgdHJhbnNmb3JtU2NhbGUgfSBmcm9tICcuL3RyYW5zZm9ybS5qcyc7XG5pbXBvcnQgeyBHZXN0dXJlSGFuZGxlciwgVGFwLCBQYW4gfSBmcm9tIFwiLi9nZXN0dXJlLmpzXCI7XG5cbmV4cG9ydCBjb25zdCBUT1BfTEVGVCA9IDA7XG5leHBvcnQgY29uc3QgVE9QX1JJR0hUID0gMTtcbmV4cG9ydCBjb25zdCBCT1RUT01fTEVGVCA9IDI7XG5leHBvcnQgY29uc3QgQk9UVE9NX1JJR0hUID0gMztcblxuZXhwb3J0IHR5cGUgQm91bmRzID0gW1BvaW50MkQsIFBvaW50MkQsIFBvaW50MkQsIFBvaW50MkRdO1xuXG5leHBvcnQgdHlwZSBWaWV3cG9ydFBvc2l0aW9uID0ge1xuICAgIHBvczogUG9pbnQyRDtcbiAgICBzY2FsZTogbnVtYmVyO1xuICAgIHJvdGF0ZTogbnVtYmVyO1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBDbGlwUG9zaXRpb24ge1xuICAgIChwb3M6IFZpZXdwb3J0UG9zaXRpb24pOiBWaWV3cG9ydFBvc2l0aW9uO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlbmRlciB7XG4gICAgKGI6IEJvdW5kcywgczogbnVtYmVyLCBjdHg6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCk6IHZvaWQ7XG59XG5cbi8vIFZpZXdwb3J0IGtlZXBzIHRyYWNrIG9mIHdvcmxkIDwtPiBzY3JlZW4gY29vcmRpbmF0ZXNcbi8vIFdvcmxkIGNvb3JkaW5hdGVzIGFyZSAreCAtPiByaWdodCwgK3kgLT4gdXBcbmV4cG9ydCBjbGFzcyBWaWV3cG9ydCB7XG4gICAgcmVhZG9ubHkgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQ7XG4gICAgcHJpdmF0ZSBwb3M6IFZpZXdwb3J0UG9zaXRpb247XG4gICAgcHJpdmF0ZSB3MmM6IEFmZmluZTJEOyAgLy8gV29ybGQgdG8gY2FudmFzIHRyYW5zZm9ybVxuICAgIHByaXZhdGUgdzJzOiBBZmZpbmUyRDsgIC8vIFdvcmxkIHRvIHNjcmVlbiB0cmFuc2Zvcm0sIGRpZmZlcmVudCBmcm9tIHcyYyBpZiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyAhPSAxXG4gICAgcHJpdmF0ZSBzMnc6IEFmZmluZTJEOyAgLy8gU2NyZWVuIHRvIHdvcmxkIHRyYW5zZm9ybVxuICAgIHByaXZhdGUgY2xlYXJTdHlsZTogbnVsbCB8IHN0cmluZyB8IENhbnZhc0dyYWRpZW50IHwgQ2FudmFzUGF0dGVybjtcbiAgICBwcml2YXRlIHJlbmRlcjogUmVuZGVyO1xuICAgIHByaXZhdGUgYm91bmRzOiBCb3VuZHM7XG4gICAgLy8gTmVlZHMgdG8gYmUgaG9va2VkIHVwIHRvIERPTSByZXNpemUgbGlzdGVuZXJcbiAgICByZXNpemU6ICgpID0+IHZvaWQ7XG5cbiAgICBwcml2YXRlIHBvc0NsaXBwZXI6IENsaXBQb3NpdGlvbiB8IG51bGw7XG5cbiAgICAvLyBSZWRyYXcgZGVib3VuY2luZyBtZXRob2RzXG4gICAgcHJpdmF0ZSByZWRyYXc6ICgpID0+IHZvaWQ7XG4gICAgcHJpdmF0ZSBjbGVhclJlY2VudFJlZHJhdzogKCkgPT4gdm9pZDtcbiAgICBwcml2YXRlIHJlY2VudFJlZHJhdzogYm9vbGVhbjtcbiAgICBwcml2YXRlIHJlZHJhd1JlcXVlc3RlZDogYm9vbGVhbjtcblxuICAgIHJlcXVlc3RSZWRyYXcoKSB7XG4gICAgICAgIGlmICh0aGlzLnJlY2VudFJlZHJhdykge1xuICAgICAgICAgICAgdGhpcy5yZWRyYXdSZXF1ZXN0ZWQgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZWRyYXcoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCByZW5kZXI6IFJlbmRlcikge1xuICAgICAgICB0aGlzLmN0eCA9IGN0eDtcbiAgICAgICAgdGhpcy5jbGVhclN0eWxlID0gXCJ3aGl0ZVwiO1xuICAgICAgICB0aGlzLnBvc0NsaXBwZXIgPSBudWxsO1xuICAgICAgICB0aGlzLnJlbmRlciA9IHJlbmRlcjtcbiAgICAgICAgdGhpcy5yZWNlbnRSZWRyYXcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZWRyYXdSZXF1ZXN0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZWRyYXcgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlY2VudFJlZHJhdyA9IHRydWU7XG4gICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5jbGVhclJlY2VudFJlZHJhdyk7XG4gICAgICAgICAgICBjb25zdCBjdHggPSB0aGlzLmN0eDtcbiAgICAgICAgICAgIGlmICh0aGlzLmNsZWFyU3R5bGUgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxsU3R5bGUgPSBjdHguZmlsbFN0eWxlO1xuICAgICAgICAgICAgICAgIGN0eC5maWxsU3R5bGUgPSB0aGlzLmNsZWFyU3R5bGU7XG4gICAgICAgICAgICAgICAgY3R4LnJlc2V0VHJhbnNmb3JtKCk7XG4gICAgICAgICAgICAgICAgY3R4LmZpbGxSZWN0KDAsIDAsIGN0eC5jYW52YXMud2lkdGgsIGN0eC5jYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZmlsbFN0eWxlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMudzJjO1xuICAgICAgICAgICAgY3R4LnNldFRyYW5zZm9ybSh0WzBdLCB0WzNdLCB0WzFdLCB0WzRdLCB0WzJdLCB0WzVdKTtcbiAgICAgICAgICAgIHRoaXMucmVuZGVyKHRoaXMuYm91bmRzLCB0aGlzLnBvcy5zY2FsZSwgY3R4KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNsZWFyUmVjZW50UmVkcmF3ID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgcmVxdWVzdGVkID0gdGhpcy5yZWRyYXdSZXF1ZXN0ZWQ7XG4gICAgICAgICAgICB0aGlzLnJlY2VudFJlZHJhdyA9IGZhbHNlO1xuICAgICAgICAgICAgdGhpcy5yZWRyYXdSZXF1ZXN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChyZXF1ZXN0ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJlZHJhdygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMucmVzaXplID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICAgICAgY2FudmFzLndpZHRoID0gY2FudmFzLm9mZnNldFdpZHRoICogd2luZG93LmRldmljZVBpeGVsUmF0aW87XG4gICAgICAgICAgICBjYW52YXMuaGVpZ2h0ID0gY2FudmFzLm9mZnNldEhlaWdodCAqIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xuICAgICAgICAgICAgdGhpcy5zZXRQb3NpdGlvbih0aGlzLnBvcyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5jdHguY2FudmFzO1xuICAgICAgICBjYW52YXMud2lkdGggPSBjYW52YXMub2Zmc2V0V2lkdGggKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbztcbiAgICAgICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy5vZmZzZXRIZWlnaHQgKiB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbztcblxuICAgICAgICAvLyBXaWxsIGJlIHJlc2V0IGluIHNldExvY2F0aW9uIGJlbG93LlxuICAgICAgICB0aGlzLnBvcyA9IHsgcG9zOiBbMC4wLCAwLjBdLCBzY2FsZTogMS4wLCByb3RhdGU6IDAuMCB9O1xuICAgICAgICB0aGlzLnMydyA9IFswLjAsIDAuMCwgMC4wLCAwLjAsIDAuMCwgMC4wXTtcbiAgICAgICAgdGhpcy53MmMgPSBbMC4wLCAwLjAsIDAuMCwgMC4wLCAwLjAsIDAuMF07XG4gICAgICAgIHRoaXMudzJzID0gWzAuMCwgMC4wLCAwLjAsIDAuMCwgMC4wLCAwLjBdO1xuICAgICAgICB0aGlzLmJvdW5kcyA9IFtcbiAgICAgICAgICAgIFswLjAsIDAuMF0sXG4gICAgICAgICAgICBbMC4wLCAwLjBdLFxuICAgICAgICAgICAgWzAuMCwgMC4wXSxcbiAgICAgICAgICAgIFswLjAsIDAuMF0sXG4gICAgICAgIF07XG4gICAgICAgIHRoaXMuc2V0UG9zaXRpb24odGhpcy5wb3MpO1xuICAgIH1cblxuICAgIHNldENsZWFyU3R5bGUoY2xlYXJTdHlsZTogbnVsbCB8IHN0cmluZyB8IENhbnZhc0dyYWRpZW50IHwgQ2FudmFzUGF0dGVybikge1xuICAgICAgICB0aGlzLmNsZWFyU3R5bGUgPSBjbGVhclN0eWxlO1xuICAgICAgICB0aGlzLnJlcXVlc3RSZWRyYXcoKTtcbiAgICB9XG5cbiAgICBzZXRDbGlwUG9zaXRpb24oY2xpcDogQ2xpcFBvc2l0aW9uKSB7XG4gICAgICAgIHRoaXMucG9zQ2xpcHBlciA9IGNsaXA7XG4gICAgICAgIHRoaXMuc2V0UG9zaXRpb24odGhpcy5wb3MpO1xuICAgIH1cblxuICAgIHNldFBvc2l0aW9uKHBvczogUGFydGlhbDxWaWV3cG9ydFBvc2l0aW9uPikge1xuICAgICAgICBpZiAocG9zLnBvcyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLnBvcy5wb3MgPSBwb3MucG9zO1xuICAgICAgICB9XG4gICAgICAgIGlmIChwb3Mucm90YXRlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGlmIChwb3Mucm90YXRlID49IE1hdGguUEkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcy5yb3RhdGUgPSBwb3Mucm90YXRlIC0gTWF0aC5mbG9vcihwb3Mucm90YXRlIC8gKDIuMCAqIE1hdGguUEkpKSAqIDIuMCAqIE1hdGguUEk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHBvcy5yb3RhdGUgPCAtTWF0aC5QSSkge1xuICAgICAgICAgICAgICAgIHRoaXMucG9zLnJvdGF0ZSA9IHBvcy5yb3RhdGUgLSBNYXRoLmNlaWwocG9zLnJvdGF0ZSAvICgyLjAgKiBNYXRoLlBJKSkgKiAyLjAgKiBNYXRoLlBJO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnBvcy5yb3RhdGUgPSBwb3Mucm90YXRlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChwb3Muc2NhbGUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5wb3Muc2NhbGUgPSBwb3Muc2NhbGU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMucG9zQ2xpcHBlciAhPT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5wb3MgPSB0aGlzLnBvc0NsaXBwZXIodGhpcy5wb3MpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuY3R4LmNhbnZhcztcbiAgICAgICAgY29uc3QgZHByID0gd2luZG93LmRldmljZVBpeGVsUmF0aW87XG4gICAgICAgIGNvbnN0IHdpZHRoID0gY2FudmFzLm9mZnNldFdpZHRoO1xuICAgICAgICBjb25zdCBoZWlnaHQgPSBjYW52YXMub2Zmc2V0SGVpZ2h0O1xuICAgICAgICBsZXQgdzIgPSB0cmFuc2Zvcm1UcmFuc2xhdGVDcmVhdGUoLXRoaXMucG9zLnBvc1swXSwgLXRoaXMucG9zLnBvc1sxXSk7XG4gICAgICAgIHcyID0gdHJhbnNmb3JtUm90YXRlKHcyLCB0aGlzLnBvcy5yb3RhdGUpO1xuICAgICAgICB3MiA9IHRyYW5zZm9ybVN0cmV0Y2godzIsIHRoaXMucG9zLnNjYWxlLCAtdGhpcy5wb3Muc2NhbGUpO1xuICAgICAgICB3MiA9IHRyYW5zZm9ybVRyYW5zbGF0ZSh3Miwgd2lkdGggKiAwLjUsIGhlaWdodCAqIDAuNSk7XG4gICAgICAgIHRoaXMudzJzID0gdzI7XG4gICAgICAgIHcyID0gdHJhbnNmb3JtU2NhbGUodzIsIGRwcik7XG4gICAgICAgIHRoaXMudzJjID0gdzI7XG5cbiAgICAgICAgY29uc3QgczJ3ID0gdHJhbnNmb3JtSW52ZXJ0KHRoaXMudzJzKTtcbiAgICAgICAgdGhpcy5ib3VuZHNbMF0gPSB0cmFuc2Zvcm1Qb2ludChzMncsIFswLCAwXSk7XG4gICAgICAgIHRoaXMuYm91bmRzWzFdID0gdHJhbnNmb3JtUG9pbnQoczJ3LCBbd2lkdGgsIDBdKTtcbiAgICAgICAgdGhpcy5ib3VuZHNbMl0gPSB0cmFuc2Zvcm1Qb2ludChzMncsIFswLCBoZWlnaHRdKTtcbiAgICAgICAgdGhpcy5ib3VuZHNbM10gPSB0cmFuc2Zvcm1Qb2ludChzMncsIFt3aWR0aCwgaGVpZ2h0XSk7XG4gICAgICAgIHRoaXMuczJ3ID0gczJ3O1xuICAgICAgICB0aGlzLnJlcXVlc3RSZWRyYXcoKTtcbiAgICB9XG5cbiAgICBwb3NpdGlvbigpOiBSZWFkb25seTxWaWV3cG9ydFBvc2l0aW9uPiB7XG4gICAgICAgIHJldHVybiB0aGlzLnBvcztcbiAgICB9XG5cbiAgICBzY3JlZW4yd29ybGQoKTogUmVhZG9ubHk8QWZmaW5lMkQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuczJ3O1xuICAgIH1cblxuICAgIHdvcmxkMnNjcmVlbigpOiBSZWFkb25seTxBZmZpbmUyRD4ge1xuICAgICAgICByZXR1cm4gdGhpcy53MnM7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgUGFuR2VzdHVyZSBpbXBsZW1lbnRzIEdlc3R1cmVIYW5kbGVyIHtcbiAgICBwcml2YXRlIHZwOiBWaWV3cG9ydDtcblxuICAgIGNvbnN0cnVjdG9yKHZwOiBWaWV3cG9ydCkge1xuICAgICAgICB0aGlzLnZwID0gdnA7XG4gICAgfVxuXG4gICAgdGFwKF90OiBUYXApIHsgfVxuXG4gICAgcGFuKHBzOiBQYW4pIHtcbiAgICAgICAgaWYgKHBzLmxlbmd0aCAhPSAxKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcG9zID0gdGhpcy52cC5wb3NpdGlvbigpO1xuICAgICAgICBjb25zdCBzMncgPSB0aGlzLnZwLnNjcmVlbjJ3b3JsZCgpO1xuICAgICAgICBjb25zdCBwID0gcHNbcHMubGVuZ3RoIC0gMV07XG4gICAgICAgIGNvbnN0IGN1cnIgPSB0cmFuc2Zvcm1Qb2ludChzMncsIHAuY3Vycik7XG4gICAgICAgIGNvbnN0IHByZXYgPSB0cmFuc2Zvcm1Qb2ludChzMncsIHAucHJldik7XG4gICAgICAgIHRoaXMudnAuc2V0UG9zaXRpb24oe1xuICAgICAgICAgICAgcG9zOiBwb2ludEFkZChwb3MucG9zLCBwb2ludFN1YihwcmV2LCBjdXJyKSksXG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFBpbmNoWm9vbUdlc3R1cmUgaW1wbGVtZW50cyBHZXN0dXJlSGFuZGxlciB7XG4gICAgcHJpdmF0ZSB2cDogVmlld3BvcnQ7XG5cbiAgICBjb25zdHJ1Y3Rvcih2cDogVmlld3BvcnQpIHtcbiAgICAgICAgdGhpcy52cCA9IHZwO1xuICAgIH1cblxuICAgIHRhcChfdDogVGFwKSB7IH1cblxuICAgIHBhbihwczogUGFuKSB7XG4gICAgICAgIGlmIChwcy5sZW5ndGggPCAyKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcG9zID0gdGhpcy52cC5wb3NpdGlvbigpO1xuICAgICAgICBjb25zdCBzMncgPSB0aGlzLnZwLnNjcmVlbjJ3b3JsZCgpO1xuICAgICAgICBjb25zdCBwMSA9IHBzW3BzLmxlbmd0aCAtIDFdO1xuICAgICAgICBjb25zdCBwMiA9IHBzW3BzLmxlbmd0aCAtIDJdO1xuXG4gICAgICAgIGNvbnN0IHdwMXByZXYgPSB0cmFuc2Zvcm1Qb2ludChzMncsIHAxLnByZXYpO1xuICAgICAgICBjb25zdCBjdXJyYSA9IHBvaW50QW5nbGUocG9pbnRTdWIocDIuY3VyciwgcDEuY3VycikpO1xuICAgICAgICBjb25zdCBwcmV2YSA9IHBvaW50QW5nbGUocG9pbnRTdWIocDIucHJldiwgcDEucHJldikpO1xuICAgICAgICBjb25zdCBjdXJybCA9IHBvaW50RGlzdGFuY2UocDEuY3VyciwgcDIuY3Vycik7XG4gICAgICAgIGNvbnN0IHByZXZsID0gcG9pbnREaXN0YW5jZShwMS5wcmV2LCBwMi5wcmV2KTtcbiAgICAgICAgY29uc3Qgd3AxY3VyciA9IHRyYW5zZm9ybVBvaW50KHMydywgcDEuY3Vycik7XG4gICAgICAgIGxldCB0ID0gdHJhbnNmb3JtVHJhbnNsYXRlQ3JlYXRlKC13cDFjdXJyWzBdLCAtd3AxY3VyclsxXSk7XG4gICAgICAgIHQgPSB0cmFuc2Zvcm1TY2FsZSh0LCBwcmV2bCAvIGN1cnJsKTtcbiAgICAgICAgdCA9IHRyYW5zZm9ybVJvdGF0ZSh0LCBwcmV2YSAtIGN1cnJhKTtcbiAgICAgICAgdCA9IHRyYW5zZm9ybVRyYW5zbGF0ZSh0LCB3cDFwcmV2WzBdLCB3cDFwcmV2WzFdKTtcbiAgICAgICAgLy8gVE9ETzogd2h5IGRvZXMgdGhpcyB3b3JrPyBJc24ndCBpdCBiYWNrd2FyZHM/XG5cbiAgICAgICAgdGhpcy52cC5zZXRQb3NpdGlvbih7XG4gICAgICAgICAgICBwb3M6IHRyYW5zZm9ybVBvaW50KHQsIHBvcy5wb3MpLFxuICAgICAgICAgICAgc2NhbGU6IHBvcy5zY2FsZSAqIGN1cnJsIC8gcHJldmwsXG4gICAgICAgICAgICByb3RhdGU6IHBvcy5yb3RhdGUgLSBwcmV2YSArIGN1cnJhLFxuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=