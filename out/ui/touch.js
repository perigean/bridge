// Copyright Charles Dueck 2020
;
export class TouchDemux {
    constructor(element, handler) {
        this.element = element;
        this.handler = handler;
        this.active = new Map();
        this.start = (evt) => {
            evt.preventDefault();
            for (const touch of evt.touches) {
                if (!this.active.has(touch.identifier)) {
                    const start = [touch.clientX, touch.clientY];
                    const extra = this.handler.touchBegin(touch.identifier, start);
                    const tm = Object.assign({ id: touch.identifier, start: start, prev: start, curr: start }, extra);
                    this.active.set(touch.identifier, tm);
                }
            }
        };
        this.move = (evt) => {
            evt.preventDefault();
            let moved = false;
            for (const touch of evt.touches) {
                const tm = this.active.get(touch.identifier);
                if (tm === undefined) {
                    throw new Error("Touch moved without being started");
                }
                if (tm.curr[0] != touch.clientX || tm.curr[1] != touch.clientY) {
                    moved = true;
                    tm.prev = tm.curr;
                    tm.curr = [touch.clientX, touch.clientY];
                }
            }
            if (moved) {
                this.handler.touchMove([...this.active.values()]);
            }
        };
        this.end = (evt) => {
            evt.preventDefault();
            const removed = new Set(this.active.keys());
            for (const t of evt.touches) {
                removed.delete(t.identifier);
            }
            for (const id of removed) {
                this.active.delete(id);
                this.handler.touchEnd(id);
            }
        };
        this.element.addEventListener("touchstart", this.start, false);
        this.element.addEventListener("touchmove", this.move, false);
        this.element.addEventListener("touchend", this.end, false);
        this.element.addEventListener("touchcancel", this.end, false);
    }
    disconnect() {
        this.element.removeEventListener("touchstart", this.start, false);
        this.element.removeEventListener("touchmove", this.move, false);
        this.element.removeEventListener("touchend", this.end, false);
        this.element.removeEventListener("touchcancel", this.end, false);
    }
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG91Y2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdWkvdG91Y2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsK0JBQStCO0FBZTlCLENBQUM7QUFFRixNQUFNLE9BQU8sVUFBVTtJQVNuQixZQUFZLE9BQW9CLEVBQUUsT0FBZ0M7UUFDOUQsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRXhCLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxHQUFlLEVBQUUsRUFBRTtZQUM3QixHQUFHLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDckIsS0FBSyxNQUFNLEtBQUssSUFBSSxHQUFHLENBQUMsT0FBTyxFQUFFO2dCQUM3QixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFO29CQUNwQyxNQUFNLEtBQUssR0FBWSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO29CQUN0RCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFDO29CQUMvRCxNQUFNLEVBQUUsbUJBQ0osRUFBRSxFQUFFLEtBQUssQ0FBQyxVQUFVLEVBQ3BCLEtBQUssRUFBRSxLQUFLLEVBQ1osSUFBSSxFQUFFLEtBQUssRUFDWCxJQUFJLEVBQUUsS0FBSyxJQUNSLEtBQUssQ0FDWCxDQUFDO29CQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFDLENBQUM7aUJBQ3pDO2FBQ0o7UUFDTCxDQUFDLENBQUM7UUFDRixJQUFJLENBQUMsSUFBSSxHQUFH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QUM7SUFDckUsQ0FBQztDQUNKO0FBQUEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCBDaGFybGVzIER1ZWNrIDIwMjBcblxuaW1wb3J0IHsgUG9pbnQyRCB9IGZyb20gXCIuLi9wb2ludC5qc1wiXG5cbmV4cG9ydCB0eXBlIFRvdWNoTW92ZSA9IHtcbiAgICBpZDogbnVtYmVyO1xuICAgIHN0YXJ0OiBQb2ludDJEO1xuICAgIHByZXY6IFBvaW50MkQ7XG4gICAgY3VycjogUG9pbnQyRDtcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG91Y2hIYW5kbGVyPEV4dHJhRGF0YT4ge1xuICAgIHRvdWNoQmVnaW46IChpZDogbnVtYmVyLCBwOiBQb2ludDJEKSA9PiBFeHRyYURhdGE7XG4gICAgdG91Y2hNb3ZlOiAodHM6IEFycmF5PFRvdWNoTW92ZT4pID0+IHZvaWQ7XG4gICAgdG91Y2hFbmQ6IChpZDogbnVtYmVyKSA9PiB2b2lkO1xufTtcblxuZXhwb3J0IGNsYXNzIFRvdWNoRGVtdXg8RXh0cmFEYXRhPiB7XG4gICAgcHJpdmF0ZSBlbGVtZW50OiBIVE1MRWxlbWVudDtcbiAgICBwcml2YXRlIGhhbmRsZXI6IFRvdWNoSGFuZGxlcjxFeHRyYURhdGE+O1xuICAgIHByaXZhdGUgYWN0aXZlOiBNYXA8bnVtYmVyLCBUb3VjaE1vdmUgJiBFeHRyYURhdGE+O1xuXG4gICAgcHJpdmF0ZSBzdGFydDogKGV2dDogVG91Y2hFdmVudCkgPT4gdm9pZDtcbiAgICBwcml2YXRlIG1vdmU6IChldnQ6IFRvdWNoRXZlbnQpID0+IHZvaWQ7XG4gICAgcHJpdmF0ZSBlbmQ6IChldnQ6IFRvdWNoRXZlbnQpID0+IHZvaWQ7XG5cbiAgICBjb25zdHJ1Y3RvcihlbGVtZW50OiBIVE1MRWxlbWVudCwgaGFuZGxlcjogVG91Y2hIYW5kbGVyPEV4dHJhRGF0YT4pIHtcbiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDtcbiAgICAgICAgdGhpcy5oYW5kbGVyID0gaGFuZGxlcjtcbiAgICAgICAgdGhpcy5hY3RpdmUgPSBuZXcgTWFwKCk7XG5cbiAgICAgICAgdGhpcy5zdGFydCA9IChldnQ6IFRvdWNoRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgZm9yIChjb25zdCB0b3VjaCBvZiBldnQudG91Y2hlcykge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5hY3RpdmUuaGFzKHRvdWNoLmlkZW50aWZpZXIpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0OiBQb2ludDJEID0gW3RvdWNoLmNsaWVudFgsIHRvdWNoLmNsaWVudFldO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBleHRyYSA9IHRoaXMuaGFuZGxlci50b3VjaEJlZ2luKHRvdWNoLmlkZW50aWZpZXIsIHN0YXJ0KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdG06IFRvdWNoTW92ZSAmIEV4dHJhRGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiB0b3VjaC5pZGVudGlmaWVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0LFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJldjogc3RhcnQsXG4gICAgICAgICAgICAgICAgICAgICAgICBjdXJyOiBzdGFydCxcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmV4dHJhLFxuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZS5zZXQodG91Y2guaWRlbnRpZmllciwgdG0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTsgXG4gICAgICAgIHRoaXMubW92ZSA9IChldnQ6IFRvdWNoRXZlbnQpID0+IHtcbiAgICAgICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgICAgICBsZXQgbW92ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgdG91Y2ggb2YgZXZ0LnRvdWNoZXMpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0bSA9IHRoaXMuYWN0aXZlLmdldCh0b3VjaC5pZGVudGlmaWVyKTtcbiAgICAgICAgICAgICAgICBpZiAodG0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJUb3VjaCBtb3ZlZCB3aXRob3V0IGJlaW5nIHN0YXJ0ZWRcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0bS5jdXJyWzBdICE9IHRvdWNoLmNsaWVudFggfHwgdG0uY3VyclsxXSAhPSB0b3VjaC5jbGllbnRZKSB7XG4gICAgICAgICAgICAgICAgICAgIG1vdmVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdG0ucHJldiA9IHRtLmN1cnI7XG4gICAgICAgICAgICAgICAgICAgIHRtLmN1cnIgPSBbdG91Y2guY2xpZW50WCwgdG91Y2guY2xpZW50WV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG1vdmVkKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVyLnRvdWNoTW92ZShbLi4udGhpcy5hY3RpdmUudmFsdWVzKCldKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5lbmQgPSAoZXZ0OiBUb3VjaEV2ZW50KSA9PiB7XG4gICAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTtcbiAgICBcbiAgICAgICAgICAgIGNvbnN0IHJlbW92ZWQgPSBuZXcgU2V0PG51bWJlcj4odGhpcy5hY3RpdmUua2V5cygpKTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiBldnQudG91Y2hlcykge1xuICAgICAgICAgICAgICAgIHJlbW92ZWQuZGVsZXRlKHQuaWRlbnRpZmllcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmb3IgKGNvbnN0IGlkIG9mIHJlbW92ZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFjdGl2ZS5kZWxldGUoaWQpO1xuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlci50b3VjaEVuZChpZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hzdGFydFwiLCB0aGlzLnN0YXJ0LCBmYWxzZSk7XG4gICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwidG91Y2htb3ZlXCIsIHRoaXMubW92ZSwgZmFsc2UpO1xuICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoZW5kXCIsIHRoaXMuZW5kLCBmYWxzZSk7XG4gICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKFwidG91Y2hjYW5jZWxcIiwgdGhpcy5lbmQsIGZhbHNlKTtcbiAgICB9XG5cbiAgICBkaXNjb25uZWN0KCkge1xuICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInRvdWNoc3RhcnRcIiwgdGhpcy5zdGFydCwgZmFsc2UpO1xuICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInRvdWNobW92ZVwiLCB0aGlzLm1vdmUsIGZhbHNlKTtcbiAgICAgICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJ0b3VjaGVuZFwiLCB0aGlzLmVuZCwgZmFsc2UpO1xuICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihcInRvdWNoY2FuY2VsXCIsIHRoaXMuZW5kLCBmYWxzZSk7XG4gICAgfVxufTtcbiJdfQ==