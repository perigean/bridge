// Copyright 2021 Charles Dueck
export class TrussSimPlayer {
    constructor(sim, h, keyInterval) {
        this.sim = sim;
        this.h = h;
        this.tLatest = 0;
        this.keyInterval = keyInterval;
        this.keyframes = new Map();
        this.playTimer = undefined;
        this.playSpeed = 0;
        this.playTime = 0;
        this.playTick = (ms, ec) => {
            // Only compute up to 100ms of frames per tick, to allow other things to happen if we are behind.
            let t1 = Math.min(this.playTime + ms * 0.001 * this.playSpeed, this.sim.t + 0.1);
            while (this.sim.t < t1) {
                this.next();
            }
            ec.requestDraw();
        };
        // Store the initial keyframe as whatever state we were passed, so we can always seek back to it.
        this.keyframes.set(this.sim.t, this.sim.save());
    }
    next() {
        const prevT = this.sim.t;
        this.sim.next(this.h);
        const isKeyframe = Math.floor(prevT / this.keyInterval) !== Math.floor(this.sim.t / this.keyInterval);
        if (this.tLatest < this.sim.t) {
            if (isKeyframe) {
                this.keyframes.set(this.sim.t, this.sim.save());
            }
            this.tLatest = this.sim.t;
        }
        else if (isKeyframe) {
            const s = this.keyframes.get(this.sim.t);
            if (s === undefined) {
                console.log(`frame ${this.sim.t} should be a keyframe`);
                return;
            }
            if (!this.sim.stateEquals(s)) {
                throw new Error(`non-deterministic playback at t ${this.sim.t}`);
            }
        }
    }
    speed() {
        return this.playSpeed;
    }
    play(ec, speed) {
        if (this.playSpeed === speed) {
            return;
        }
        if (this.playTimer !== undefined) {
            this.pause(ec);
        }
        this.playTime = this.sim.t;
        this.playSpeed = speed;
        this.playTimer = ec.timer(this.playTick, undefined);
    }
    pause(ec) {
        if (this.playTimer === undefined) {
            return;
        }
        ec.clearTimer(this.playTimer);
        this.playTimer = undefined;
        this.playSpeed = 0;
    }
    seekTimes() {
        return this.keyframes.keys();
    }
    seek(t, ec) {
        const y = this.keyframes.get(t);
        if (y === undefined) {
            throw new Error(`${t} is not a keyframe time`);
        }
        this.sim.restore(t, y);
        if (this.playTimer !== undefined) {
            const speed = this.playSpeed;
            this.pause(ec);
            this.play(ec, speed);
        }
    }
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJ1c3NzaW1wbGF5ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdHJ1c3NzaW1wbGF5ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsK0JBQStCO0FBSy9CLE1BQU0sT0FBTyxjQUFjO0lBV3ZCLFlBQVksR0FBYSxFQUFFLENBQVMsRUFBRSxXQUFtQjtRQUNyRCxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNmLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ1gsSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDLENBQUM7UUFDakIsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ2xCLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxFQUFVLEVBQUUsRUFBa0IsRUFBRSxFQUFFO1lBQy9DLGlHQUFpRztZQUNqRyxJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxHQUFHLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBQ2pGLE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO2dCQUNwQixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDZjtZQUNELEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNyQixDQUFDLENBQUM7UUFDRixpR0FBaUc7UUFDakcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FB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QUksS0FBSyxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1NBQ2xEO1FBQ0QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksSUFBSSxDQUFDLFNBQVMsS0FBSyxTQUFTLEVBQUU7WUFDOUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ2YsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDeEI7SUFDTCxDQUFDO0NBQ0o7QUFBQSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMjEgQ2hhcmxlcyBEdWVja1xuXG5pbXBvcnQgeyBUcnVzc1NpbSwgVHJ1c3NTaW1TdGF0ZSB9IGZyb20gXCIuL3RydXNzc2ltLmpzXCI7XG5pbXBvcnQgeyBFbGVtZW50Q29udGV4dCwgVGltZXJIYW5kbGVyIH0gZnJvbSBcIi4vdWkvbm9kZS5qc1wiO1xuXG5leHBvcnQgY2xhc3MgVHJ1c3NTaW1QbGF5ZXIge1xuICAgIHNpbTogVHJ1c3NTaW07XG4gICAgcHJpdmF0ZSBoOiBudW1iZXI7ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGltZSBzdGVwLlxuICAgIHByaXZhdGUgdExhdGVzdDogbnVtYmVyOyAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBoaWdoZXN0IHRpbWUgdmFsdWUgc2ltdWxhdGVkLlxuICAgIHByaXZhdGUga2V5SW50ZXJ2YWw6IG51bWJlcjsgICAgICAgICAgICAgICAgICAgIC8vIFRpbWUgcGVyIGtleWZyYW1lLlxuICAgIHByaXZhdGUga2V5ZnJhbWVzOiBNYXA8bnVtYmVyLCBUcnVzc1NpbVN0YXRlPjsgICAvLyBNYXAgb2YgdGltZSB0byBzYXZlZCBzdGF0ZS5cbiAgICBwcml2YXRlIHBsYXlUaW1lcjogbnVtYmVyIHwgdW5kZWZpbmVkO1xuICAgIHByaXZhdGUgcGxheVNwZWVkOiBudW1iZXI7XG4gICAgcHJpdmF0ZSBwbGF5VGltZTogbnVtYmVyO1xuICAgIHByaXZhdGUgcGxheVRpY2s6IFRpbWVySGFuZGxlcjtcblxuICAgIGNvbnN0cnVjdG9yKHNpbTogVHJ1c3NTaW0sIGg6IG51bWJlciwga2V5SW50ZXJ2YWw6IG51bWJlcikge1xuICAgICAgICB0aGlzLnNpbSA9IHNpbTtcbiAgICAgICAgdGhpcy5oID0gaDtcbiAgICAgICAgdGhpcy50TGF0ZXN0ID0gMDtcbiAgICAgICAgdGhpcy5rZXlJbnRlcnZhbCA9IGtleUludGVydmFsO1xuICAgICAgICB0aGlzLmtleWZyYW1lcyA9IG5ldyBNYXAoKTtcbiAgICAgICAgdGhpcy5wbGF5VGltZXIgPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMucGxheVNwZWVkID0gMDtcbiAgICAgICAgdGhpcy5wbGF5VGltZSA9IDA7XG4gICAgICAgIHRoaXMucGxheVRpY2sgPSAobXM6IG51bWJlciwgZWM6IEVsZW1lbnRDb250ZXh0KSA9PiB7XG4gICAgICAgICAgICAvLyBPbmx5IGNvbXB1dGUgdXAgdG8gMTAwbXMgb2YgZnJhbWVzIHBlciB0aWNrLCB0byBhbGxvdyBvdGhlciB0aGluZ3MgdG8gaGFwcGVuIGlmIHdlIGFyZSBiZWhpbmQuXG4gICAgICAgICAgICBsZXQgdDEgPSBNYXRoLm1pbih0aGlzLnBsYXlUaW1lICsgbXMgKiAwLjAwMSAqIHRoaXMucGxheVNwZWVkLCB0aGlzLnNpbS50ICsgMC4xKTtcbiAgICAgICAgICAgIHdoaWxlICh0aGlzLnNpbS50IDwgdDEpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm5leHQoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVjLnJlcXVlc3REcmF3KCk7XG4gICAgICAgIH07XG4gICAgICAgIC8vIFN0b3JlIHRoZSBpbml0aWFsIGtleWZyYW1lIGFzIHdoYXRldmVyIHN0YXRlIHdlIHdlcmUgcGFzc2VkLCBzbyB3ZSBjYW4gYWx3YXlzIHNlZWsgYmFjayB0byBpdC5cbiAgICAgICAgdGhpcy5rZXlmcmFtZXMuc2V0KHRoaXMuc2ltLnQsIHRoaXMuc2ltLnNhdmUoKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBuZXh0KCkge1xuICAgICAgICBjb25zdCBwcmV2VCA9IHRoaXMuc2ltLnQ7XG4gICAgICAgIHRoaXMuc2ltLm5leHQodGhpcy5oKTtcbiAgICAgICAgY29uc3QgaXNLZXlmcmFtZSA9IE1hdGguZmxvb3IocHJldlQgLyB0aGlzLmtleUludGVydmFsKSAhPT0gTWF0aC5mbG9vcih0aGlzLnNpbS50IC8gdGhpcy5rZXlJbnRlcnZhbCk7XG4gICAgICAgIGlmICh0aGlzLnRMYXRlc3QgPCB0aGlzLnNpbS50KSB7XG4gICAgICAgICAgICBpZiAoaXNLZXlmcmFtZSkge1xuICAgICAgICAgICAgICAgIHRoaXMua2V5ZnJhbWVzLnNldCh0aGlzLnNpbS50LCB0aGlzLnNpbS5zYXZlKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy50TGF0ZXN0ID0gdGhpcy5zaW0udDtcbiAgICAgICAgfSBlbHNlIGlmIChpc0tleWZyYW1lKSB7XG4gICAgICAgICAgICBjb25zdCBzID0gdGhpcy5rZXlmcmFtZXMuZ2V0KHRoaXMuc2ltLnQpO1xuICAgICAgICAgICAgaWYgKHMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBmcmFtZSAke3RoaXMuc2ltLnR9IHNob3VsZCBiZSBhIGtleWZyYW1lYCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCF0aGlzLnNpbS5zdGF0ZUVxdWFscyhzKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgbm9uLWRldGVybWluaXN0aWMgcGxheWJhY2sgYXQgdCAke3RoaXMuc2ltLnR9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzcGVlZCgpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5wbGF5U3BlZWQ7XG4gICAgfVxuXG4gICAgcGxheShlYzogRWxlbWVudENvbnRleHQsIHNwZWVkOiBudW1iZXIpIHtcbiAgICAgICAgaWYgKHRoaXMucGxheVNwZWVkID09PSBzcGVlZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLnBsYXlUaW1lciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLnBhdXNlKGVjKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnBsYXlUaW1lID0gdGhpcy5zaW0udDtcbiAgICAgICAgdGhpcy5wbGF5U3BlZWQgPSBzcGVlZDtcbiAgICAgICAgdGhpcy5wbGF5VGltZXIgPSBlYy50aW1lcih0aGlzLnBsYXlUaWNrLCB1bmRlZmluZWQpO1xuICAgIH1cblxuICAgIHBhdXNlKGVjOiBFbGVtZW50Q29udGV4dCkge1xuICAgICAgICBpZiAodGhpcy5wbGF5VGltZXIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGVjLmNsZWFyVGltZXIodGhpcy5wbGF5VGltZXIpO1xuICAgICAgICB0aGlzLnBsYXlUaW1lciA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5wbGF5U3BlZWQgPSAwO1xuICAgIH1cblxuICAgIHNlZWtUaW1lcygpOiBJdGVyYWJsZUl0ZXJhdG9yPG51bWJlcj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5rZXlmcmFtZXMua2V5cygpO1xuICAgIH1cblxuICAgIHNlZWsodDogbnVtYmVyLCBlYzogRWxlbWVudENvbnRleHQpIHtcbiAgICAgICAgY29uc3QgeSA9IHRoaXMua2V5ZnJhbWVzLmdldCh0KTtcbiAgICAgICAgaWYgKHkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3R9IGlzIG5vdCBhIGtleWZyYW1lIHRpbWVgKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNpbS5yZXN0b3JlKHQsIHkpO1xuICAgICAgICBpZiAodGhpcy5wbGF5VGltZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgY29uc3Qgc3BlZWQgPSB0aGlzLnBsYXlTcGVlZDtcbiAgICAgICAgICAgIHRoaXMucGF1c2UoZWMpO1xuICAgICAgICAgICAgdGhpcy5wbGF5KGVjLCBzcGVlZCk7XG4gICAgICAgIH1cbiAgICB9XG59OyJdfQ==